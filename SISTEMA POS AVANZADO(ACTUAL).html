<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema POS - Kiosco</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Variables CSS */
        
         :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Dark Mode */
        
        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f1f5f9;
            --border-color: #334155;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3);
        }
        /* Base Styles */
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            transition: var(--transition);
            line-height: 1.6;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        /* Navbar */
        
        .navbar {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--shadow);
            z-index: 100;
            position: relative;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            flex: 1;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .nav-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .nav-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            color: var(--secondary-color);
            transition: var(--transition);
            font-size: 0.875rem;
            white-space: nowrap;
            position: relative;
            min-width: fit-content;
        }
        
        .nav-tab:hover {
            background: var(--bg-color);
            color: var(--text-color);
            transform: translateY(-1px);
        }
        
        .nav-tab.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-lg);
        }
        
        .nav-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .time-display {
            font-size: 0.875rem;
            color: var(--secondary-color);
            font-weight: 500;
        }
        
        .connection-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%,
            100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        /* Main Content */
        
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }
        
        .section {
            display: none;
            width: 100%;
            padding: 1rem;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .breadcrumb {
            font-size: 0.875rem;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        /* Cards */
        
        .card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }
        
        .grid {
            display: grid;
            gap: 1rem;
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        /* Buttons */
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            position: relative;
            overflow: hidden;
            min-height: 36px;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background: #475569;
            transform: translateY(-2px);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        /* Inputs */
        
        .input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 0.875rem;
            transition: var(--transition);
        }
        
        .input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
            transform: translateY(-1px);
        }
        
        .input-group {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .input-group .input {
            padding-right: 3rem;
        }
        
        .input-group-icon {
            position: absolute;
            right: 0.75rem;
            color: var(--secondary-color);
            pointer-events: none;
        }
        /* Forms */
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-color);
        }
        
        .form-help {
            font-size: 0.75rem;
            color: var(--secondary-color);
            margin-top: 0.25rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }
        /* Sales Section */
        
        .sales-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 1rem;
            height: calc(100vh - 120px);
        }
        
        .product-search {
            margin-bottom: 1rem;
            position: relative;
        }
        
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .search-suggestion {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
        }
        
        .search-suggestion:hover {
            background: var(--bg-color);
        }
        
        .search-suggestion:last-child {
            border-bottom: none;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
            max-height: 500px;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .product-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .product-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-lg);
            transform: translateY(-3px);
        }
        
        .product-card.out-of-stock {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .product-card.low-stock {
            border-color: var(--warning-color);
        }
        
        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--success-color);
        }
        
        .product-card.low-stock::before {
            background: var(--warning-color);
        }
        
        .product-card.out-of-stock::before {
            background: var(--danger-color);
        }
        
        .product-image {
            width: 60px;
            height: 60px;
            background: var(--bg-color);
            border-radius: 0.5rem;
            margin: 0 auto 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .product-name {
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            line-height: 1.2;
            height: 2.4em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .product-price {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .product-stock {
            font-size: 0.7rem;
            color: var(--secondary-color);
            margin-top: 0.25rem;
            font-weight: 600;
        }
        /* Product Hover Card */
        
        .product-hover-card {
            position: absolute;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            padding: 0.75rem;
            z-index: 20;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            min-width: 180px;
            max-width: 250px;
            text-align: left;
            transform: translate(-50%, -110%);
            /* Position above and centered */
            left: 50%;
        }
        
        .product-card:hover .product-hover-card {
            opacity: 1;
        }
        
        .product-hover-card h5 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--primary-color);
        }
        
        .product-hover-card p {
            font-size: 0.75rem;
            color: var(--secondary-color);
            margin-bottom: 0.25rem;
        }
        /* Cart */
        
        .cart {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            position: sticky;
            top: 1rem;
            height: fit-content;
        }
        
        .cart-header {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .cart-count {
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .cart-items {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            max-height: 300px;
        }
        
        .cart-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .cart-item:hover {
            background: var(--bg-color);
        }
        
        .cart-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .cart-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .cart-item-name {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .cart-item-price {
            font-size: 0.75rem;
            color: var(--secondary-color);
        }
        
        .cart-item-total {
            font-size: 0.75rem;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-color);
            border-radius: 0.5rem;
            padding: 0.25rem;
        }
        
        .quantity-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 0.25rem;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .quantity-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.1);
        }
        
        .quantity-input {
            width: 50px;
            text-align: center;
            padding: 0.25rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            font-size: 0.75rem;
            background: var(--card-bg);
        }
        
        .cart-total {
            padding-top: 1rem;
            border-top: 2px solid var(--border-color);
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .total-final {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary-color);
            padding: 0.5rem;
            background: var(--bg-color);
            border-radius: 0.5rem;
            margin: 0.5rem 0;
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        .payment-btn {
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            background: var(--card-bg);
            cursor: pointer;
            text-align: center;
            transition: var(--transition);
            font-size: 0.75rem;
        }
        
        .payment-btn:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .payment-btn.selected {
            border-color: var(--primary-color);
            background: rgb(37 99 235 / 0.1);
            color: var(--primary-color);
            font-weight: 600;
        }
        /* Tables */
        
        .table-container {
            overflow-x: auto;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .table th,
        .table td {
            padding: 1rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .table th {
            background: var(--bg-color);
            font-weight: 600;
            font-size: 0.875rem;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .table td {
            font-size: 0.875rem;
        }
        
        .table tr:hover {
            background: var(--bg-color);
        }
        
        .table tr:last-child td {
            border-bottom: none;
        }
        /* Modals */
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        
        .modal.active {
            display: flex;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px) scale(0.95);
            }
            to {
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary-color);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .close-btn:hover {
            background: var(--bg-color);
            color: var(--danger-color);
        }
        /* Notifications */
        
        .notification {
            position: fixed;
            top: 80px;
            right: 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            min-width: 300px;
            max-width: 400px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .notification-icon {
            font-size: 1.25rem;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .notification-message {
            font-size: 0.875rem;
            color: var(--secondary-color);
        }
        
        .notification.success {
            border-left: 4px solid var(--success-color);
        }
        
        .notification.success .notification-icon {
            color: var(--success-color);
        }
        
        .notification.error {
            border-left: 4px solid var(--danger-color);
        }
        
        .notification.error .notification-icon {
            color: var(--danger-color);
        }
        
        .notification.warning {
            border-left: 4px solid var(--warning-color);
        }
        
        .notification.warning .notification-icon {
            color: var(--warning-color);
        }
        
        .notification.info {
            border-left: 4px solid var(--info-color);
        }
        
        .notification.info .notification-icon {
            color: var(--info-color);
        }
        /* Stats Grid */
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }
        
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.8;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--secondary-color);
        }
        
        .stat-change {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }
        
        .stat-change.positive {
            color: var(--success-color);
        }
        
        .stat-change.negative {
            color: var(--danger-color);
        }
        /* Empty State */
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--secondary-color);
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        
        .empty-state-description {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }
        /* Badges */
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            gap: 0.25rem;
        }
        
        .badge-success {
            background: rgb(16 185 129 / 0.1);
            color: var(--success-color);
            border: 1px solid rgb(16 185 129 / 0.2);
        }
        
        .badge-warning {
            background: rgb(245 158 11 / 0.1);
            color: var(--warning-color);
            border: 1px solid rgb(245 158 11 / 0.2);
        }
        
        .badge-danger {
            background: rgb(239 68 68 / 0.1);
            color: var(--danger-color);
            border: 1px solid rgb(239 68 68 / 0.2);
        }
        
        .badge-info {
            background: rgb(59 130 246 / 0.1);
            color: var(--info-color);
            border: 1px solid rgb(59 130 246 / 0.2);
        }
        /* Quick Actions */
        
        .quick-actions {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 100;
        }
        
        .quick-action-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }
        
        .quick-action-btn:hover {
            transform: scale(1.1);
        }
        /* Form Validation */
        
        .required {
            color: var(--danger-color);
        }
        
        .input.error {
            border-color: var(--danger-color);
        }
        
        .input.error:focus {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 3px rgb(239 68 68 / 0.1);
        }
        
        .error-message {
            color: var(--danger-color);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        /* Loading Spinner */
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        /* Custom Confirmation Modal */
        
        .confirmation-modal .modal-content {
            max-width: 400px;
            text-align: center;
        }
        
        .confirmation-modal .modal-content .modal-header {
            justify-content: center;
            border-bottom: none;
            margin-bottom: 1rem;
        }
        
        .confirmation-modal .modal-content .modal-title {
            font-size: 1.5rem;
            color: var(--warning-color);
        }
        
        .confirmation-modal .modal-content .modal-body {
            margin-bottom: 1.5rem;
            font-size: 1rem;
            color: var(--text-color);
        }
        
        .confirmation-modal .modal-content .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        /* Chart Styles (simple list based) */
        
        .chart-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .chart-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        
        .chart-list-item:last-child {
            border-bottom: none;
        }
        
        .chart-list-item-label {
            font-weight: 500;
            color: var(--text-color);
            flex-basis: 30%;
            /* Adjust as needed */
            min-width: 80px;
        }
        
        .chart-list-item-value {
            font-weight: 600;
            color: var(--primary-color);
            flex-basis: 30%;
            /* Adjust as needed */
            text-align: right;
            min-width: 80px;
        }
        
        .chart-bar-container {
            width: 100%;
            background-color: var(--bg-color);
            border-radius: 0.25rem;
            overflow: hidden;
            margin-top: 0.25rem;
            flex-basis: 100%;
        }
        
        .chart-bar {
            height: 8px;
            background: var(--gradient-primary);
            border-radius: 0.25rem;
            transition: width 0.5s ease-out;
        }
        /* Responsive Design */
        
        @media (max-width: 768px) {
            .sales-layout {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            .nav-tab-text {
                display: none;
            }
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            .payment-methods {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .section-header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            .quick-actions {
                bottom: 1rem;
                right: 1rem;
            }
            .notification {
                right: 0.5rem;
                left: 0.5rem;
                transform: translateY(-100%);
                min-width: auto;
            }
            .notification.show {
                transform: translateY(0);
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .form-row-3 {
                grid-template-columns: 1fr;
            }
            .modal-content {
                max-width: 95%;
                padding: 1rem;
            }
            .chart-list-item-label,
            .chart-list-item-value {
                flex-basis: 48%;
                /* Adjust for smaller screens */
            }
        }
        /* Custom scrollbar */
        
         ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
         ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }
        
         ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
         ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Navigation Bar -->
        <nav class="navbar">
            <div class="logo">
                <i class="fas fa-store"></i> POS Kiosco
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" data-section="inicio">
                    <span class="nav-tab-icon"><i class="fas fa-home"></i></span>
                    <span class="nav-tab-text">Inicio</span>
                </button>
                <button class="nav-tab" data-section="ventas">
                    <span class="nav-tab-icon"><i class="fas fa-cash-register"></i></span>
                    <span class="nav-tab-text">Ventas</span>
                </button>
                <button class="nav-tab" data-section="productos">
                    <span class="nav-tab-icon"><i class="fas fa-box-open"></i></span>
                    <span class="nav-tab-text">Productos</span>
                </button>
                <button class="nav-tab" data-section="categorias">
                    <span class="nav-tab-icon"><i class="fas fa-tags"></i></span>
                    <span class="nav-tab-text">Categor√≠as</span>
                </button>
                <button class="nav-tab" data-section="historial">
                    <span class="nav-tab-icon"><i class="fas fa-history"></i></span>
                    <span class="nav-tab-text">Historial</span>
                </button>
                <button class="nav-tab" data-section="reportes">
                    <span class="nav-tab-icon"><i class="fas fa-chart-line"></i></span>
                    <span class="nav-tab-text">Reportes</span>
                </button>
                <button class="nav-tab" data-section="clientes">
                    <span class="nav-tab-icon"><i class="fas fa-users"></i></span>
                    <span class="nav-tab-text">Clientes</span>
                </button>
                <button class="nav-tab" data-section="personalizacion">
                    <span class="nav-tab-icon"><i class="fas fa-palette"></i></span>
                    <span class="nav-tab-text">Personalizaci√≥n</span>
                </button>
                <button class="nav-tab" data-section="configuracion">
                    <span class="nav-tab-icon"><i class="fas fa-cog"></i></span>
                    <span class="nav-tab-text">Configuraci√≥n</span>
                </button>
            </div>
            <div class="nav-controls">
                <button class="btn btn-secondary" id="theme-toggle" title="Cambiar tema">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="time-display" id="current-time"></div>
                <div class="connection-status" title="Sistema conectado"></div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Inicio Section -->
            <section id="inicio" class="section active">
                <div class="section-header">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-home"></i> Panel de Control
                        </h1>
                        <div class="breadcrumb">
                            Inicio > Dashboard Principal
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="stat-value" id="today-sales">$0.00</div>
                        <div class="stat-label">Ventas Hoy</div>
                        <div class="stat-change positive" id="today-sales-change">
                            <span><i class="fas fa-arrow-up"></i></span> N/A
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
                        <div class="stat-value" id="today-transactions">0</div>
                        <div class="stat-label">Transacciones</div>
                        <div class="stat-change positive" id="today-transactions-change">
                            <span><i class="fas fa-arrow-up"></i></span> N/A
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stat-value" id="low-stock-count">0</div>
                        <div class="stat-label">Stock Bajo</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-boxes"></i></div>
                        <div class="stat-value" id="total-products">0</div>
                        <div class="stat-label">Productos Activos</div>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="card">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-bolt"></i> Accesos R√°pidos
                        </h3>
                        <div class="grid">
                            <button class="btn btn-primary" onclick="switchSection('ventas')">
                                <i class="fas fa-cash-register"></i> Nueva Venta
                            </button>
                            <button class="btn btn-success" onclick="switchSection('productos')">
                                <i class="fas fa-box-open"></i> Gestionar Productos
                            </button>
                            <button class="btn btn-warning" onclick="openModal('cash-close-modal')">
                                <i class="fas fa-lock"></i> Cierre de Caja
                            </button>
                            <button class="btn btn-info" onclick="generateQuickReport()">
                                <i class="fas fa-chart-pie"></i> Reporte R√°pido
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-trophy"></i> Productos M√°s Vendidos
                        </h3>
                        <div id="top-products">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="fas fa-chart-bar"></i></div>
                                <div class="empty-state-title">No hay datos disponibles</div>
                                <div class="empty-state-description">
                                    Realiza algunas ventas para ver estad√≠sticas
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ventas Section -->
            <section id="ventas" class="section">
                <div class="section-header">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-cash-register"></i> Punto de Venta
                        </h1>
                        <div class="breadcrumb">
                            Inicio > Ventas > Punto de Venta
                        </div>
                    </div>
                </div>

                <div class="sales-layout">
                    <div>
                        <div class="product-search">
                            <div class="input-group">
                                <input type="text" class="input" id="product-search" placeholder="Buscar por nombre, c√≥digo o escanear..." onkeyup="searchProducts(event)" autocomplete="off">
                                <button class="btn btn-secondary" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); padding: 0.25rem 0.5rem;" onclick="clearSearch('product-search')" title="Limpiar b√∫squeda">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="search-suggestions" id="search-suggestions">
                                <!-- Search suggestions will appear here -->
                            </div>

                            <!-- Advanced Filters -->
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                <select class="input" id="category-filter" onchange="filterProducts()" style="flex: 1; min-width: 120px;">
                                    <option value="all">üìÇ Todas las categor√≠as</option>
                                </select>
                                <select class="input" id="stock-filter" onchange="filterProducts()" style="flex: 1; min-width: 120px;">
                                    <option value="all">üì¶ Todo el stock</option>
                                    <option value="available">‚úÖ Disponible</option>
                                    <option value="low">‚ö†Ô∏è Stock bajo</option>
                                    <option value="out">‚ùå Sin stock</option>
                                </select>
                                <button class="btn btn-secondary" onclick="clearFilters()" title="Limpiar filtros">
                                    <i class="fas fa-filter-slash"></i>
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3><i class="fas fa-boxes"></i> Productos Disponibles</h3>
                            </div>
                            <div class="product-grid" id="product-grid">
                                <!-- Products will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <div class="cart">
                        <div class="cart-header">
                            <i class="fas fa-shopping-cart"></i> Carrito de Compras
                            <div class="cart-count" id="cart-count">0</div>
                        </div>

                        <div class="cart-items" id="cart-items">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="fas fa-shopping-cart"></i></div>
                                <div class="empty-state-title">Carrito vac√≠o</div>
                                <div class="empty-state-description">
                                    Agrega productos para comenzar
                                </div>
                            </div>
                        </div>

                        <div class="cart-total">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span id="cart-subtotal">$0.00</span>
                            </div>
                            <div class="total-row">
                                <span>IVA (<span id="cart-tax-rate">21</span>%):</span>
                                <span id="cart-tax">$0.00</span>
                            </div>
                            <div class="total-row total-final">
                                <span>Total:</span>
                                <span id="cart-total">$0.00</span>
                            </div>
                        </div>

                        <div style="margin: 1rem 0;">
                            <label class="form-label">Cliente (Opcional):</label>
                            <input type="text" class="input" id="customer-name-sale" placeholder="Nombre del cliente">
                        </div>

                        <div class="payment-methods">
                            <div class="payment-btn selected" data-method="cash">
                                <i class="fas fa-money-bill-wave"></i><br>Efectivo
                            </div>
                            <div class="payment-btn" data-method="card">
                                <i class="fas fa-credit-card"></i><br>Tarjeta
                            </div>
                            <div class="payment-btn" data-method="transfer">
                                <i class="fas fa-university"></i><br>Transferencia
                            </div>
                        </div>

                        <button class="btn btn-success" style="width: 100%; margin-top: 1rem;" onclick="processSale()" id="finalize-sale-btn">
                            <i class="fas fa-check-circle"></i> Finalizar Venta <small>(F9)</small>
                        </button>

                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button class="btn btn-secondary" style="flex: 1;" onclick="clearCartConfirm()">
                                <i class="fas fa-trash-alt"></i> Limpiar
                            </button>
                            <button class="btn btn-info" style="flex: 1;" onclick="saveCartDraft()">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                            <button class="btn btn-warning" style="flex: 1;" onclick="loadCartDraft()">
                                <i class="fas fa-folder-open"></i> Cargar
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Productos Section -->
            <section id="productos" class="section">
                <div class="section-header">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-box-open"></i> Gesti√≥n de Productos
                        </h1>
                        <div class="breadcrumb">
                            Inicio > Productos > Gesti√≥n de Inventario
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="openModal('product-modal')">
                            <i class="fas fa-plus-circle"></i> Nuevo Producto
                        </button>
                        <button class="btn btn-success" onclick="exportProducts()">
                            <i class="fas fa-file-export"></i> Exportar CSV
                        </button>
                        <button class="btn btn-info" onclick="openModal('import-modal')">
                            <i class="fas fa-file-import"></i> Importar CSV
                        </button>
                        <button class="btn btn-warning" onclick="openModal('bulk-actions-modal')">
                            <i class="fas fa-bolt"></i> Acciones Masivas
                        </button>
                        <button class="btn btn-secondary" onclick="createBackup()">
                            <i class="fas fa-save"></i> Crear Respaldo
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <span id="products-count">0 productos</span> encontrados
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <label style="font-size: 0.875rem; color: var(--secondary-color);">Ordenar por:</label>
                            <select class="input" id="sort-products" onchange="sortProducts()" style="width: auto;">
                                <option value="name">üìù Nombre</option>
                                <option value="code">üî¢ C√≥digo</option>
                                <option value="price">üí∞ Precio</option>
                                <option value="stock">üì¶ Stock</option>
                                <option value="category">üìÇ Categor√≠a</option>
                            </select>
                            <button class="btn btn-secondary" onclick="toggleSortOrder()" id="sort-order-btn" title="Cambiar orden">
                                <i class="fas fa-sort-alpha-down"></i>
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table" id="products-table">
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Nombre</th>
                                    <th>Categor√≠a</th>
                                    <th>Marca</th>
                                    <th>Unidad</th>
                                    <th>Precio</th>
                                    <th>Stock</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body">
                                <!-- Products will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Categorias Section -->
            <section id="categorias" class="section">
                <div class="section-header">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-tags"></i> Gesti√≥n de Categor√≠as
                        </h1>
                        <div class="breadcrumb">
                            Inicio > Categor√≠as > Administrar Categor√≠as
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="openCategoryModal()">
                        <i class="fas fa-plus-circle"></i> Nueva Categor√≠a
                    </button>
                </div>

                <div class="card">
                    <div style="margin-bottom: 1rem;">
                        <span id="categories-count">0 categor√≠as</span> registradas
                    </div>
                    <div class="table-container">
                        <table class="table" id="categories-table">
                            <thead>
                                <tr>
                                    <th>Icono</th>
                                    <th>Nombre</th>
                                    <th>Productos Asociados</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="categories-table-body">
                                <!-- Categories will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Historial Section -->
            <section id="historial" class="section">
                <div class="section-header">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-history"></i> Historial de Ventas
                        </h1>
                        <div class="breadcrumb">
                            Inicio > Historial > Registro de Transacciones
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="margin-bottom: 1rem;">
                        <!-- History Filters -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <input type="date" class="input" id="history-date-from" onchange="filterHistory()" style="flex: 1; min-width: 140px;">
                            <input type="date" class="input" id="history-date-to" onchange="filterHistory()" style="flex: 1; min-width: 140px;">
                            <select class="input" id="history-payment-filter" onchange="filterHistory()" style="flex: 1; min-width: 120px;">
                                <option value="all">üí≥ Todos los pagos</option>
                                <option value="cash">üíµ Efectivo</option>
                                <option value="card">üí≥ Tarjeta</option>
                                <option value="transfer">üè¶ Transferencia</option>
                            </select>
                            <button class="btn btn-secondary" onclick="clearHistoryFilters()" title="Limpiar filtros">
                                <i class="fas fa-filter-slash"></i>
                            </button>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span id="history-count">0 transacciones</span> encontradas
                            </div>
                            <div>
                                Total: <strong id="history-total">$0.00</strong>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table" id="history-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th>Total</th>
                                    <th>M√©todo de Pago</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <!-- History will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Reportes Section -->
            <section id="reportes" class="section">
                <div class="section-header">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-chart-line"></i> Centro de Reportes
                        </h1>
                        <div class="breadcrumb">
                            Inicio > Reportes > Generaci√≥n de Informes
                        </div>
                    </div>
                </div>

                <div class="grid grid-3">
                    <div class="card">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-chart-bar"></i> Reporte de Ventas
                        </h3>
                        <p style="margin-bottom: 1rem; color: var(--secondary-color);">
                            Generar reporte detallado de ventas por per√≠odo
                        </p>
                        <div class="form-group">
                            <label class="form-label">üìÖ Desde:</label>
                            <input type="date" class="input" id="sales-report-from">
                        </div>
                        <div class="form-group">
                            <label class="form-label">üìÖ Hasta:</label>
                            <input type="date" class="input" id="sales-report-to">
                        </div>
                        <button class="btn btn-primary" onclick="generateSalesReport()">
                            <i class="fas fa-file-alt"></i> Generar Reporte
                        </button>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-boxes"></i> Reporte de Inventario
                        </h3>
                        <p style="margin-bottom: 1rem; color: var(--secondary-color);">
                            Estado actual del inventario y alertas de stock
                        </p>
                        <button class="btn btn-success" onclick="generateInventoryReport()">
                            <i class="fas fa-file-alt"></i> Generar Reporte
                        </button>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-money-check-alt"></i> Reporte Financiero
                        </h3>
                        <p style="margin-bottom: 1rem; color: var(--secondary-color);">
                            An√°lisis financiero completo con rentabilidad
                        </p>
                        <button class="btn btn-warning" onclick="generateFinancialReport()">
                            <i class="fas fa-file-alt"></i> Generar Reporte
                        </button>
                    </div>
                </div>

                <div class="card" style="margin-top: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-chart-pie"></i> Estad√≠sticas Detalladas
                    </h3>
                    <div class="grid grid-2">
                        <div>
                            <h4>Ventas por Categor√≠a</h4>
                            <ul class="chart-list" id="sales-by-category-chart">
                                <div class="empty-state" style="padding: 1rem;">
                                    <div class="empty-state-icon" style="font-size: 2rem;"><i class="fas fa-chart-bar"></i></div>
                                    <div class="empty-state-title" style="font-size: 1rem;">No hay datos de ventas por categor√≠a</div>
                                </div>
                            </ul>
                        </div>
                        <div>
                            <h4>Ventas por M√©todo de Pago</h4>
                            <ul class="chart-list" id="sales-by-payment-chart">
                                <div class="empty-state" style="padding: 1rem;">
                                    <div class="empty-state-icon" style="font-size: 2rem;"><i class="fas fa-credit-card"></i></div>
                                    <div class="empty-state-title" style="font-size: 1rem;">No hay datos de ventas por m√©todo de pago</div>
                                </div>
                            </ul>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <h4>Resumen de Rentabilidad</h4>
                        <div class="grid grid-2">
                            <div class="stat-card" style="padding: 1rem; text-align: left; border-left: 3px solid var(--info-color);">
                                <div class="stat-label">Costo Total de Ventas</div>
                                <div class="stat-value" style="font-size: 1.5rem;" id="total-cost-of-sales">$0.00</div>
                            </div>
                            <div class="stat-card" style="padding: 1rem; text-align: left; border-left: 3px solid var(--success-color);">
                                <div class="stat-label">Ganancia Bruta</div>
                                <div class="stat-value" style="font-size: 1.5rem;" id="gross-profit">$0.00</div>
                            </div>
                            <div class="stat-card" style="padding: 1rem; text-align: left; border-left: 3px solid var(--primary-color);">
                                <div class="stat-label">Margen de Ganancia</div>
                                <div class="stat-value" style="font-size: 1.5rem;" id="profit-margin">0%</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <h4>Estad√≠sticas Adicionales</h4>
                        <div class="grid grid-2">
                            <div class="stat-card" style="padding: 1rem; text-align: left; border-left: 3px solid var(--info-color);">
                                <div class="stat-label">Valor Promedio Transacci√≥n</div>
                                <div class="stat-value" style="font-size: 1.5rem;" id="avg-transaction-value">$0.00</div>
                            </div>
                            <div class="stat-card" style="padding: 1rem; text-align: left; border-left: 3px solid var(--primary-color);">
                                <div class="stat-label">Valor Inventario (Costo)</div>
                                <div class="stat-value" style="font-size: 1.5rem;" id="inventory-value-cost">$0.00</div>
                            </div>
                            <div class="stat-card" style="padding: 1rem; text-align: left; border-left: 3px solid var(--success-color);">
                                <div class="stat-label">Valor Inventario (Venta)</div>
                                <div class="stat-value" style="font-size: 1.5rem;" id="inventory-value-retail">$0.00</div>
                            </div>
                        </div>
                        <h4 style="margin-top: 1rem;">Ventas por Hora del D√≠a</h4>
                        <ul class="chart-list" id="sales-by-hour-chart">
                            <div class="empty-state" style="padding: 1rem;">
                                <div class="empty-state-icon" style="font-size: 2rem;"><i class="fas fa-clock"></i></div>
                                <div class="empty-state-title" style="font-size: 1rem;">No hay datos de ventas por hora</div>
                            </div>
                        </ul>
                        <h4 style="margin-top: 1rem;">Ventas por D√≠a de la Semana</h4>
                        <ul class="chart-list" id="sales-by-day-of-week-chart">
                            <div class="empty-state" style="padding: 1rem;">
                                <div class="empty-state-icon" style="font-size: 2rem;"><i class="fas fa-calendar-alt"></i></div>
                                <div class="empty-state-title" style="font-size: 1rem;">No hay datos de ventas por d√≠a de la semana</div>
                            </div>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Clientes Section -->
            <section id="clientes" class="section">
                <div class="section-header">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-users"></i> Gesti√≥n de Clientes
                        </h1>
                        <div class="breadcrumb">
                            Inicio > Clientes > Base de Datos de Clientes
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="openModal('customer-modal')">
                            <i class="fas fa-user-plus"></i> Nuevo Cliente
                        </button>
                        <button class="btn btn-success" onclick="exportCustomers()">
                            <i class="fas fa-file-export"></i> Exportar Clientes
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <span id="customers-count">0 clientes</span> registrados
                        </div>
                        <div class="input-group" style="width: 300px;">
                            <input type="text" class="input" id="customer-search" placeholder="Buscar cliente..." onkeyup="searchCustomers()">
                            <button class="btn btn-secondary" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); padding: 0.25rem 0.5rem;" onclick="clearSearch('customer-search')" title="Limpiar b√∫squeda">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table" id="customers-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Tel√©fono</th>
                                    <th>Total Compras</th>
                                    <th>√öltima Compra</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="customers-table-body">
                                <!-- Customers will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Personalizacion Section -->
            <section id="personalizacion" class="section">
                <div class="section-header">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-palette"></i> Personalizaci√≥n
                        </h1>
                        <div class="breadcrumb">
                            Inicio > Personalizaci√≥n > Ajustes de Interfaz
                        </div>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="card">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-adjust"></i> Apariencia
                        </h3>
                        <div class="form-group">
                            <label class="form-label">Tema:</label>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-outline" onclick="setTheme('light')" id="theme-light-btn">
                                    <i class="fas fa-sun"></i> Claro
                                </button>
                                <button class="btn btn-outline" onclick="setTheme('dark')" id="theme-dark-btn">
                                    <i class="fas fa-moon"></i> Oscuro
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">S√≠mbolo de Moneda:</label>
                            <input type="text" class="input" id="currency-symbol" value="$" maxlength="3">
                            <div class="form-help">Cambia el s√≠mbolo de moneda (ej: $, ‚Ç¨, ¬£)</div>
                        </div>
                        <button class="btn btn-primary" onclick="savePersonalizationSettings()">
                            <i class="fas fa-save"></i> Guardar Personalizaci√≥n
                        </button>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-bell"></i> Preferencias de Notificaciones
                        </h3>
                        <div class="form-group">
                            <label class="form-label">Mostrar notificaciones de stock bajo:</label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="notify-low-stock" checked>
                                Habilitar
                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="savePersonalizationSettings()">
                            <i class="fas fa-save"></i> Guardar Preferencias
                        </button>
                    </div>
                </div>
            </section>

            <!-- Configuraci√≥n Section -->
            <section id="configuracion" class="section">
                <div class="section-header">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-cog"></i> Configuraci√≥n del Sistema
                        </h1>
                        <div class="breadcrumb">
                            Inicio > Configuraci√≥n > Ajustes Generales
                        </div>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="card">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-store"></i> Informaci√≥n del Negocio
                        </h3>
                        <div class="form-group">
                            <label class="form-label">Nombre del Negocio:</label>
                            <input type="text" class="input" id="business-name" value="Kiosco POS">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Direcci√≥n:</label>
                            <input type="text" class="input" id="business-address" placeholder="Direcci√≥n completa del negocio">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tel√©fono:</label>
                            <input type="tel" class="input" id="business-phone" placeholder="+54 11 1234-5678">
                        </div>
                        <button class="btn btn-primary" onclick="saveBusinessInfo()">
                            <i class="fas fa-save"></i> Guardar Informaci√≥n
                        </button>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-credit-card"></i> Configuraci√≥n de Pagos
                        </h3>
                        <div class="form-group">
                            <label class="form-label">IVA por Defecto (%):</label>
                            <input type="number" class="input" id="default-tax" value="21" min="0" max="100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">M√©todos de Pago Activos:</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="enable-cash" checked>
                                    üíµ Efectivo
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="enable-card" checked>
                                    üí≥ Tarjeta de Cr√©dito/D√©bito
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="enable-transfer" checked>
                                    üè¶ Transferencia Bancaria
                                </label>
                            </div>
                        </div>
                        <button class="btn btn-warning" onclick="savePaymentSettings()">
                            <i class="fas fa-save"></i> Guardar Configuraci√≥n
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="quick-action-btn" onclick="switchSection('ventas')" title="Nueva Venta">
                <i class="fas fa-cash-register"></i>
            </button>
            <button class="quick-action-btn" onclick="openModal('product-modal')" title="Agregar Producto">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <!-- Modals -->
    <!-- Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-box-open"></i> Gesti√≥n de Producto</h2>
                <button class="close-btn" onclick="closeModal('product-modal')"><i class="fas fa-times"></i></button>
            </div>
            <form id="product-form" onsubmit="saveProduct(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">C√≥digo de Barras <span class="required">*</span>:</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="input" id="product-code" required readonly style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="generateBarcode()" title="Generar nuevo c√≥digo">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button type="button" class="btn btn-outline" onclick="toggleManualCode()" id="manual-code-btn" title="Editar manualmente">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                        <div class="error-message" id="code-error">Este campo es obligatorio</div>
                        <div class="form-help">C√≥digo √∫nico generado autom√°ticamente</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categor√≠a:</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <select class="input" id="product-category" style="flex: 1;" onchange="handleCategoryChange()">
                                <option value="">Seleccionar categor√≠a</option>
                                <option value="__new__">‚ûï Nueva Categor√≠a</option>
                            </select>
                            <button type="button" class="btn btn-success" onclick="showNewCategoryInput()" title="Agregar nueva categor√≠a">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="new-category-container" style="display: none; margin-top: 0.5rem;">
                            <input type="text" class="input" id="new-category-input" placeholder="Nombre de la nueva categor√≠a" style="margin-bottom: 0.5rem;">
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label class="form-label" style="margin: 0; font-size: 0.75rem;">Icono:</label>
                                <select class="input" id="category-icon-select" style="width: auto;">
                                    <option value="üì¶">üì¶ General</option>
                                    <option value="ü•§">ü•§ Bebidas</option>
                                    <option value="üçø">üçø Snacks</option>
                                    <option value="üç¨">üç¨ Dulces</option>
                                    <option value="üö¨">üö¨ Cigarrillos</option>
                                    <option value="üßΩ">üßΩ Limpieza</option>
                                    <option value="üß¥">üß¥ Higiene</option>
                                    <option value="ü•õ">ü•õ L√°cteos</option>
                                    <option value="üçû">üçû Panader√≠a</option>
                                    <option value="üçé">üçé Frutas</option>
                                    <option value="ü•ï">ü•ï Verduras</option>
                                    <option value="üçñ">üçñ Carnes</option>
                                    <option value="üßä">üßä Congelados</option>
                                    <option value="üì±">üì± Electr√≥nicos</option>
                                    <option value="üéÆ">üéÆ Juguetes</option>
                                    <option value="üîã">üîã Bater√≠as</option>
                                    <option value="üéß">üéß Electr√≥nica</option>
                                    <option value="üìö">üìö Libros</option>
                                    <option value="‚öΩ">‚öΩ Deportes</option>
                                    <option value="üëï">üëï Ropa</option>
                                    <option value="üíä">üíä Farmacia</option>
                                    <option value="üíÖ">üíÖ Belleza</option>
                                    <option value="üõ†Ô∏è">üõ†Ô∏è Herramientas</option>
                                    <option value="üöó">üöó Automotriz</option>
                                    <option value="üåª">üåª Jardiner√≠a</option>
                                    <option value="üêæ">üêæ Mascotas</option>
                                    <option value="üéÅ">üéÅ Regalos</option>
                                    <option value="üñäÔ∏è">üñäÔ∏è Papeler√≠a</option>
                                    <option value="üç≥">üç≥ Cocina</option>
                                    <option value="üí°">üí° Iluminaci√≥n</option>
                                    <option value="üíß">üíß Agua</option>
                                    <option value="‚òï">‚òï Caf√©</option>
                                    <option value="üç¶">üç¶ Helados</option>
                                    <option value="ü•ñ">ü•ñ Pan</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-help">Selecciona una categor√≠a existente o crea una nueva</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Nombre del Producto <span class="required">*</span>:</label>
                    <input type="text" class="input" id="product-name" required>
                    <div class="error-message" id="name-error">Este campo es obligatorio</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Descripci√≥n:</label>
                    <textarea class="input" id="product-description" rows="3" placeholder="Descripci√≥n detallada del producto (opcional)"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Marca:</label>
                        <input type="text" class="input" id="product-brand" placeholder="Ej: Coca-Cola, Bimbo">
                        <div class="form-help">Marca del producto</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unidad:</label>
                        <input type="text" class="input" id="product-unit" placeholder="Ej: litro, kg, unidad">
                        <div class="form-help">Unidad de medida o tipo de empaque</div>
                    </div>
                </div>

                <div class="form-row-3">
                    <div class="form-group">
                        <label class="form-label">Precio de Costo:</label>
                        <input type="number" class="input" id="product-cost" step="0.01" min="0" placeholder="0.00">
                        <div class="form-help">Precio de compra</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Precio de Venta <span class="required">*</span>:</label>
                        <input type="number" class="input" id="product-price" step="0.01" min="0" required placeholder="0.00">
                        <div class="error-message" id="price-error">Este campo es obligatorio</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Margen (%):</label>
                        <input type="text" class="input" id="product-margin" readonly placeholder="0%">
                        <div class="form-help">Calculado autom√°ticamente</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Stock Inicial <span class="required">*</span>:</label>
                        <input type="number" class="input" id="product-stock" min="0" required placeholder="0">
                        <div class="error-message" id="stock-error">Este campo es obligatorio</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stock M√≠nimo:</label>
                        <input type="number" class="input" id="product-min-stock" min="0" value="5" placeholder="5">
                        <div class="form-help">Alerta cuando el stock sea menor</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">IVA (%):</label>
                        <input type="number" class="input" id="product-tax-rate" min="0" max="100" step="0.1" placeholder="21">
                        <div class="form-help">Tasa de IVA para este producto (por defecto 21%)</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Proveedor:</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <select class="input" id="product-supplier" style="flex: 1;" onchange="handleSupplierChange()">
                                <option value="">Seleccionar proveedor</option>
                                <option value="__new__">‚ûï Nuevo Proveedor</option>
                            </select>
                            <button type="button" class="btn btn-success" onclick="showNewSupplierInput()" title="Agregar nuevo proveedor">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <input type="text" class="input" id="new-supplier-input" placeholder="Nombre del nuevo proveedor" style="display: none; margin-top: 0.5rem;">
                        <div class="form-help">Selecciona un proveedor existente o agrega uno nuevo</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ubicaci√≥n:</label>
                        <input type="text" class="input" id="product-location" placeholder="Estante, pasillo, etc.">
                        <div class="form-help">Ubicaci√≥n f√≠sica del producto en el local</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha de Vencimiento:</label>
                        <input type="date" class="input" id="product-expiry">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Estado:</label>
                    <select class="input" id="product-status">
                        <option value="active">‚úÖ Activo</option>
                        <option value="inactive">‚ùå Inactivo</option>
                        <option value="discontinued">üö´ Descontinuado</option>
                    </select>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-save"></i> Guardar Producto <span class="spinner" id="product-save-spinner" style="display: none;"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('product-modal')">
                        <i class="fas fa-times"></i> Cancelar <small>(Esc)</small>
                    </button>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--secondary-color); text-align: center;">
                    üí° Atajos: F2=Ventas, F3=Productos, F4=Historial, Ctrl+N=Nuevo Producto
                </div>
            </form>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-tags"></i> Gesti√≥n de Categor√≠a</h2>
                <button class="close-btn" onclick="closeModal('category-modal')"><i class="fas fa-times"></i></button>
            </div>
            <form id="category-form" onsubmit="saveCategory(event)">
                <div class="form-group">
                    <label class="form-label">Nombre de la Categor√≠a <span class="required">*</span>:</label>
                    <input type="text" class="input" id="category-name" required>
                    <div class="error-message" id="category-name-error">Este campo es obligatorio</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Icono:</label>
                    <select class="input" id="category-icon">
                        <option value="üì¶">üì¶ General</option>
                        <option value="ü•§">ü•§ Bebidas</option>
                        <option value="üçø">üçø Snacks</option>
                        <option value="üç¨">üç¨ Dulces</option>
                        <option value="üö¨">üö¨ Cigarrillos</option>
                        <option value="üßΩ">üßΩ Limpieza</option>
                        <option value="üß¥">üß¥ Higiene</option>
                        <option value="ü•õ">ü•õ L√°cteos</option>
                        <option value="üçû">üçû Panader√≠a</option>
                        <option value="üçé">üçé Frutas</option>
                        <option value="ü•ï">ü•ï Verduras</option>
                        <option value="üçñ">üçñ Carnes</option>
                        <option value="üßä">üßä Congelados</option>
                        <option value="üì±">üì± Electr√≥nicos</option>
                        <option value="üéÆ">üéÆ Juguetes</option>
                        <option value="üîã">üîã Bater√≠as</option>
                        <option value="üéß">üéß Electr√≥nica</option>
                        <option value="üìö">üìö Libros</option>
                        <option value="‚öΩ">‚öΩ Deportes</option>
                        <option value="üëï">üëï Ropa</option>
                        <option value="üíä">üíä Farmacia</option>
                        <option value="üíÖ">üíÖ Belleza</option>
                        <option value="üõ†Ô∏è">üõ†Ô∏è Herramientas</option>
                        <option value="üöó">üöó Automotriz</option>
                        <option value="üåª">üåª Jardiner√≠a</option>
                        <option value="üêæ">üêæ Mascotas</option>
                        <option value="üéÅ">üéÅ Regalos</option>
                        <option value="üñäÔ∏è">üñäÔ∏è Papeler√≠a</option>
                        <option value="üç≥">üç≥ Cocina</option>
                        <option value="üí°">üí° Iluminaci√≥n</option>
                        <option value="üíß">üíß Agua</option>
                        <option value="‚òï">‚òï Caf√©</option>
                        <option value="üç¶">üç¶ Helados</option>
                        <option value="ü•ñ">ü•ñ Pan</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-save"></i> Guardar Categor√≠a <span class="spinner" id="category-save-spinner" style="display: none;"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('category-modal')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cash Payment Modal -->
    <div id="cash-payment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üíµ Pago en Efectivo</h2>
                <button class="close-btn" onclick="closeModal('cash-payment-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 2.5rem; font-weight: bold; color: var(--primary-color);" id="cash-total">
                    $0.00
                </div>
                <div style="color: var(--secondary-color); font-size: 1.1rem;">Total a Pagar</div>
            </div>

            <div class="form-group">
                <label class="form-label">Monto Recibido:</label>
                <input type="number" class="input" id="cash-received" step="0.01" min="0" onkeyup="calculateChange()" placeholder="0.00" style="font-size: 1.2rem; text-align: center;">
            </div>

            <div style="text-align: center; margin: 1.5rem 0; padding: 1rem; background: var(--bg-color); border-radius: 0.5rem;">
                <div style="font-size: 1.8rem; font-weight: bold;" id="cash-change">
                    Cambio: $0.00
                </div>
            </div>

            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-success" style="flex: 1;" onclick="completeCashPayment()" id="confirm-cash-btn" disabled>
                    <i class="fas fa-check-circle"></i> Confirmar Pago
                </button>
                <button class="btn btn-secondary" onclick="closeModal('cash-payment-modal')">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receipt-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">üé´ Ticket de Venta</h2>
                <button class="close-btn" onclick="closeModal('receipt-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div id="receipt-content" style="font-family: 'Courier New', monospace; font-size: 0.875rem; line-height: 1.4; background: white; color: black; padding: 1rem; border-radius: 0.5rem;">
                <!-- Receipt content will be generated here -->
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="btn btn-primary" style="flex: 1;" onclick="printReceipt()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
        </div>
    </div>

    <!-- Cash Close Modal -->
    <div id="cash-close-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">üîí Cierre de Caja</h2>
                <button class="close-btn" onclick="closeModal('cash-close-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div id="cash-close-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="stat-value" id="close-total-sales">$0.00</div>
                        <div class="stat-label">Total Ventas del D√≠a</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
                        <div class="stat-value" id="close-total-transactions">0</div>
                        <div class="stat-label">Transacciones del D√≠a</div>
                    </div>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="confirmCashClose()">
                        <i class="fas fa-lock"></i> Confirmar Cierre
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üì• Importar Productos</h2>
                <button class="close-btn" onclick="closeModal('import-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div>
                <div class="form-group">
                    <label class="form-label">Seleccionar archivo CSV:</label>
                    <input type="file" class="input" id="import-file" accept=".csv" onchange="previewImport()">
                    <div class="form-help">El archivo debe tener las columnas: C√≥digo, Nombre, Categor√≠a, Marca (opcional), Unidad (opcional), Precio, Stock, IVA (opcional)</div>
                </div>
                <div id="import-preview" style="display: none; margin-top: 1rem;">
                    <h4>Vista previa:</h4>
                    <div id="import-preview-content" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.5rem;">
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="processImport()" id="import-btn" disabled>
                        <i class="fas fa-file-import"></i> Importar Productos <span class="spinner" id="import-spinner" style="display: none;"></span>
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('import-modal')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üë• Gesti√≥n de Cliente</h2>
                <button class="close-btn" onclick="closeModal('customer-modal')"><i class="fas fa-times"></i></button>
            </div>
            <form id="customer-form" onsubmit="saveCustomer(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nombre Completo <span class="required">*</span>:</label>
                        <input type="text" class="input" id="customer-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email:</label>
                        <input type="email" class="input" id="customer-email">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tel√©fono:</label>
                        <input type="tel" class="input" id="customer-phone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha de Nacimiento:</label>
                        <input type="date" class="input" id="customer-birthday">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Direcci√≥n:</label>
                    <textarea class="input" id="customer-address" rows="2"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Descuento Especial (%):</label>
                        <input type="number" class="input" id="customer-discount" min="0" max="100" step="0.1" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">L√≠mite de Cr√©dito:</label>
                        <input type="number" class="input" id="customer-credit-limit" min="0" step="0.01" value="0">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Notas:</label>
                    <textarea class="input" id="customer-notes" rows="3" placeholder="Notas adicionales sobre el cliente"></textarea>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-save"></i> Guardar Cliente <span class="spinner" id="customer-save-spinner" style="display: none;"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('customer-modal')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Actions Modal -->
    <div id="bulk-actions-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚ö° Acciones Masivas</h2>
                <button class="close-btn" onclick="closeModal('bulk-actions-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div>
                <div class="form-group">
                    <label class="form-label">Seleccionar productos:</label>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="checkbox" id="select-all-products" onchange="toggleSelectAll()">
                            <strong>Seleccionar todos</strong>
                        </label>
                        <div id="bulk-products-list">
                            <!-- Products will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Acci√≥n a realizar:</label>
                    <select class="input" id="bulk-action">
                        <option value="">Seleccionar acci√≥n</option>
                        <option value="update-price">üí∞ Actualizar precios</option>
                        <option value="update-stock">üì¶ Actualizar stock</option>
                        <option value="change-category">üìÇ Cambiar categor√≠a</option>
                        <option value="change-status">üîÑ Cambiar estado</option>
                        <option value="delete">üóëÔ∏è Eliminar productos</option>
                    </select>
                </div>
                <div id="bulk-action-params" style="display: none;">
                    <!-- Action parameters will appear here -->
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-warning" onclick="executeBulkAction()" id="bulk-execute-btn" disabled>
                        <i class="fas fa-bolt"></i> Ejecutar Acci√≥n <span class="spinner" id="bulk-action-spinner" style="display: none;"></span>
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('bulk-actions-modal')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="custom-confirm-modal" class="modal confirmation-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-question-circle"></i> Confirmar Acci√≥n</h2>
            </div>
            <div class="modal-body" id="custom-confirm-message">
                ¬øEst√°s seguro de que quieres realizar esta acci√≥n?
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="custom-confirm-yes">S√≠</button>
                <button class="btn btn-secondary" id="custom-confirm-no">No</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let cart = [];
        let sales = JSON.parse(localStorage.getItem('sales')) || [];
        let categories = JSON.parse(localStorage.getItem('categories')) || [];
        let suppliers = JSON.parse(localStorage.getItem('suppliers')) || [];
        let customers = JSON.parse(localStorage.getItem('customers')) || [];
        let cashClosures = JSON.parse(localStorage.getItem('cashClosures')) || []; // New: Store cash closures
        let selectedPaymentMethod = 'cash';
        let currentEditingProduct = null;
        let currentEditingCategory = null; // New: For category editing
        let currentEditingCustomer = null;
        let isManualCodeMode = false;
        let searchTimeout = null;
        let autoSaveInterval = null;
        let sortBy = 'name';
        let sortOrder = 'asc';
        let currentHistoryFilters = {
            dateFrom: '',
            dateTo: '',
            paymentMethod: 'all'
        };
        let defaultTaxRate = parseFloat(localStorage.getItem('defaultTax') || '21');
        let currencySymbol = localStorage.getItem('currencySymbol') || '$'; // New: Currency Symbol
        let notifyLowStock = JSON.parse(localStorage.getItem('notifyLowStock') || 'true'); // New: Notification preference


        // --- Utility Functions ---

        /**
         * Shows a custom confirmation modal.
         * @param {string} message - The message to display in the modal.
         * @returns {Promise<boolean>} - A promise that resolves to true if confirmed, false otherwise.
         */
        function customConfirm(message) {
            return new Promise(resolve => {
                const modal = document.getElementById('custom-confirm-modal');
                document.getElementById('custom-confirm-message').textContent = message;
                modal.classList.add('active');

                const yesBtn = document.getElementById('custom-confirm-yes');
                const noBtn = document.getElementById('custom-confirm-no');

                const handleYes = () => {
                    modal.classList.remove('active');
                    yesBtn.removeEventListener('click', handleYes);
                    noBtn.removeEventListener('click', handleNo);
                    resolve(true);
                };

                const handleNo = () => {
                    modal.classList.remove('active');
                    yesBtn.removeEventListener('click', handleYes);
                    noBtn.removeEventListener('click', handleNo);
                    resolve(false);
                };

                yesBtn.addEventListener('click', handleYes);
                noBtn.addEventListener('click', handleNo);

                // Close on Escape key
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        handleNo();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            });
        }

        /**
         * Shows a notification message.
         * @param {string} type - Type of notification ('success', 'error', 'warning', 'info').
         * @param {string} title - Title of the notification.
         * @param {string} message - Message content.
         */
        function showNotification(type, title, message) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            const icons = {
                success: '<i class="fas fa-check-circle"></i>',
                error: '<i class="fas fa-times-circle"></i>',
                warning: '<i class="fas fa-exclamation-triangle"></i>',
                info: '<i class="fas fa-info-circle"></i>'
            };

            notification.innerHTML = `
                <div class="notification-header">
                    <span class="notification-icon">${icons[type]}</span>
                    <span class="notification-title">${title}</span>
                </div>
                <div class="notification-message">${message}</div>
            `;

            document.body.appendChild(notification);

            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);

            // Hide notification after 4 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        /**
         * Formats a number as currency.
         * @param {number} amount - The amount to format.
         * @returns {string} - Formatted currency string.
         */
        function formatCurrency(amount) {
            return `${currencySymbol}${amount.toFixed(2)}`;
        }

        /**
         * Formats a date string.
         * @param {string} dateString - Date string in ISO format (YYYY-MM-DD).
         * @returns {string} - Formatted date string (DD/MM/YYYY).
         */
        function formatDate(dateString) {
            if (!dateString) return '-';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        /**
         * Shows/hides a spinner element.
         * @param {string} elementId - The ID of the element to toggle spinner visibility.
         * @param {boolean} show - True to show, false to hide.
         */
        function toggleSpinner(elementId, show) {
            const spinner = document.getElementById(elementId);
            if (spinner) {
                spinner.style.display = show ? 'inline-block' : 'none';
            }
        }

        /**
         * Gets the date N days ago from today.
         * @param {number} days - Number of days to go back.
         * @returns {string} Date string in YYYY-MM-DD format.
         */
        function getDateNDaysAgo(days) {
            const date = new Date();
            date.setDate(date.getDate() - days);
            return date.toISOString().split('T')[0];
        }

        // --- Core Application Logic ---

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            updateTime();
            setInterval(updateTime, 1000);

            loadProducts();
            loadCategories();
            loadSuppliers();
            loadCustomers();
            updateDashboard();
            setupEventListeners();
            loadHistory();
            loadBusinessInfo();
            loadPaymentSettings();
            loadPersonalizationSettings(); // Load personalization settings
            loadCategoryFilters();
            updateReportStatistics(); // Initial load for new stats
            loadCategoriesTable(); // Load categories table

            // Auto-save every 30 seconds
            autoSaveInterval = setInterval(autoSave, 30000);

            // Check for low stock on startup
            if (notifyLowStock) {
                checkLowStock();
            }

            // Show welcome message for new users
            if (products.length === 0 && sales.length === 0) {
                setTimeout(() => {
                    showNotification('info', '¬°Bienvenido!', 'Comienza agregando productos para usar el sistema POS');
                }, 1000);
            }

            // Set initial theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeToggleIcon(savedTheme);
            updateThemeButtons(savedTheme);
        }

        /**
         * Generates a unique 13-digit EAN-13 barcode.
         * @returns {string} The generated barcode.
         */
        function generateBarcode() {
            let code;
            do {
                // Generate a 12-digit number and append a checksum digit
                const randomPart = Math.floor(Math.random() * 1000000000000).toString().padStart(12, '0');
                let sum = 0;
                for (let i = 0; i < 12; i++) {
                    sum += parseInt(randomPart[i]) * (i % 2 === 0 ? 1 : 3);
                }
                const checksum = (10 - (sum % 10)) % 10;
                code = randomPart + checksum;
            } while (products.some(p => p.code === code));

            document.getElementById('product-code').value = code;
            return code;
        }

        /** Toggles manual barcode input mode. */
        function toggleManualCode() {
            const codeInput = document.getElementById('product-code');
            const manualBtn = document.getElementById('manual-code-btn');
            const helpText = document.querySelector('#product-code').parentElement.nextElementSibling.nextElementSibling;

            isManualCodeMode = !isManualCodeMode;
            codeInput.readOnly = !isManualCodeMode;
            manualBtn.innerHTML = isManualCodeMode ? '<i class="fas fa-lock"></i>' : '<i class="fas fa-pencil-alt"></i>';
            manualBtn.title = isManualCodeMode ? 'Bloquear edici√≥n' : 'Editar manualmente';
            helpText.textContent = isManualCodeMode ? 'Modo manual activado - Ingresa el c√≥digo manualmente' : 'C√≥digo √∫nico generado autom√°ticamente';

            if (isManualCodeMode) {
                codeInput.focus();
                codeInput.select();
            }
        }

        /** Loads categories from local storage and populates the dropdown. */
        function loadCategories() {
            const categorySelect = document.getElementById('product-category');

            // Clear existing options except default ones
            while (categorySelect.children.length > 2) {
                categorySelect.removeChild(categorySelect.lastChild);
            }

            // Add existing categories
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = `${category.icon} ${category.name}`;
                categorySelect.appendChild(option);
            });
        }

        /** Loads suppliers from local storage and populates the dropdown. */
        function loadSuppliers() {
            const supplierSelect = document.getElementById('product-supplier');

            // Clear existing options except default ones
            while (supplierSelect.children.length > 2) {
                supplierSelect.removeChild(supplierSelect.lastChild);
            }

            // Add existing suppliers
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name;
                supplierSelect.appendChild(option);
            });
        }

        /** Handles category dropdown change, showing new category input if "__new__" is selected. */
        function handleCategoryChange() {
            const categorySelect = document.getElementById('product-category');
            const newCategoryContainer = document.getElementById('new-category-container');

            if (categorySelect.value === '__new__') {
                showNewCategoryInput();
            } else {
                newCategoryContainer.style.display = 'none';
            }
        }

        /** Handles supplier dropdown change, showing new supplier input if "__new__" is selected. */
        function handleSupplierChange() {
            const supplierSelect = document.getElementById('product-supplier');
            const newSupplierInput = document.getElementById('new-supplier-input');

            if (supplierSelect.value === '__new__') {
                showNewSupplierInput();
            } else {
                newSupplierInput.style.display = 'none';
            }
        }

        /** Shows the new category input field. */
        function showNewCategoryInput() {
            const categorySelect = document.getElementById('product-category');
            const newCategoryContainer = document.getElementById('new-category-container');
            const newCategoryInput = document.getElementById('new-category-input');

            categorySelect.value = '__new__';
            newCategoryContainer.style.display = 'block';
            newCategoryInput.focus();
        }

        /** Shows the new supplier input field. */
        function showNewSupplierInput() {
            const supplierSelect = document.getElementById('product-supplier');
            const newSupplierInput = document.getElementById('new-supplier-input');

            supplierSelect.value = '__new__';
            newSupplierInput.style.display = 'block';
            newSupplierInput.focus();
        }

        /** Updates the current time display in the navbar. */
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-AR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('current-time').textContent = timeString;
        }

        /** Sets up all major event listeners for navigation, forms, and shortcuts. */
        function setupEventListeners() {
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    switchSection(section);
                });
            });

            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

            // Payment method selection
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.payment-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedPaymentMethod = this.getAttribute('data-method');
                });
            });

            // Modal close on background click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });

            // Product form calculations
            document.getElementById('product-cost').addEventListener('input', calculateMargin);
            document.getElementById('product-price').addEventListener('input', calculateMargin);

            // Form validation
            document.getElementById('product-form').addEventListener('input', validateProductForm);
            document.getElementById('category-form').addEventListener('input', validateCategoryForm); // New: Category form validation

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Global shortcuts
                if (e.key === 'F2') {
                    e.preventDefault();
                    switchSection('ventas');
                } else if (e.key === 'F3') {
                    e.preventDefault();
                    switchSection('productos');
                } else if (e.key === 'F4') {
                    e.preventDefault();
                    switchSection('historial');
                } else if (e.key === 'F5') {
                    e.preventDefault();
                    switchSection('reportes');
                } else if (e.key === 'Escape') {
                    closeAllModals();
                } else if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    openModal('product-modal');
                } else if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (document.getElementById('product-modal').classList.contains('active')) {
                        document.getElementById('product-form').dispatchEvent(new Event('submit'));
                    } else {
                        autoSave();
                        showNotification('success', 'Guardado', 'Datos guardados autom√°ticamente');
                    }
                } else if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    const searchInput = document.getElementById('product-search');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                    }
                } else if (e.key === 'F9') {
                    e.preventDefault();
                    if (document.getElementById('ventas').classList.contains('active')) {
                        processSale();
                    }
                }
            });

            // Auto-focus on cash received input
            document.getElementById('cash-received').addEventListener('focus', function() {
                this.select();
            });
        }

        /** Calculates and displays the profit margin for a product. */
        function calculateMargin() {
            const cost = parseFloat(document.getElementById('product-cost').value) || 0;
            const price = parseFloat(document.getElementById('product-price').value) || 0;

            if (cost > 0 && price > 0) {
                const margin = ((price - cost) / cost * 100).toFixed(1);
                document.getElementById('product-margin').value = margin + '%';
            } else {
                document.getElementById('product-margin').value = '';
            }
        }

        /** Validates the product form fields. */
        function validateProductForm() {
            const requiredFields = ['product-code', 'product-name', 'product-price', 'product-stock'];
            let isValid = true;

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const errorElement = document.getElementById(fieldId.replace('product-', '') + '-error');

                if (!field.value.trim()) {
                    field.classList.add('error');
                    if (errorElement) errorElement.classList.add('show');
                    isValid = false;
                } else {
                    field.classList.remove('error');
                    if (errorElement) errorElement.classList.remove('show');
                }
            });

            return isValid;
        }

        /** Validates the category form fields. */
        function validateCategoryForm() {
            const nameField = document.getElementById('category-name');
            const errorElement = document.getElementById('category-name-error');
            let isValid = true;

            if (!nameField.value.trim()) {
                nameField.classList.add('error');
                errorElement.classList.add('show');
                isValid = false;
            } else {
                nameField.classList.remove('error');
                errorElement.classList.remove('show');
            }
            return isValid;
        }

        /**
         * Switches the active section of the application.
         * @param {string} sectionName - The ID of the section to activate.
         */
        function switchSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionName).classList.add('active');

            // Update navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

            // Load section-specific data
            if (sectionName === 'productos') {
                loadProductsTable();
            } else if (sectionName === 'historial') {
                loadHistory();
            } else if (sectionName === 'reportes') {
                updateReportStatistics();
            } else if (sectionName === 'categorias') { // New: Load categories table
                loadCategoriesTable();
            } else if (sectionName === 'personalizacion') { // New: Load personalization settings
                loadPersonalizationSettings();
            }
        }

        /** Loads and displays products in the sales section grid. */
        function loadProducts() {
            const productGrid = document.getElementById('product-grid');
            productGrid.innerHTML = '';

            if (products.length === 0) {
                productGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-box-open"></i></div>
                        <div class="empty-state-title">No hay productos</div>
                        <div class="empty-state-description">
                            Agrega productos para comenzar a vender
                        </div>
                        <button class="btn btn-primary" onclick="openModal('product-modal')">
                            <i class="fas fa-plus-circle"></i> Agregar Primer Producto
                        </button>
                    </div>
                `;
                return;
            }

            products.forEach(product => {
                        if (product.status === 'inactive') return;

                        const productCard = document.createElement('div');
                        productCard.className = 'product-card';

                        if (product.stock === 0) {
                            productCard.classList.add('out-of-stock');
                        } else if (product.stock <= (product.minStock || 5)) {
                            productCard.classList.add('low-stock');
                        }

                        const categoryIcon = getCategoryIcon(product.category);

                        productCard.innerHTML = `
                    <div class="product-image">${categoryIcon}</div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">${formatCurrency(product.price)}</div>
                    <div class="product-stock">Stock: ${product.stock}</div>
                    <div class="product-hover-card">
                        <h5>${product.name}</h5>
                        ${product.brand ? `<p><strong>Marca:</strong> ${product.brand}</p>` : ''}
                        ${product.unit ? `<p><strong>Unidad:</strong> ${product.unit}</p>` : ''}
                        ${product.description ? `<p>${product.description}</p>` : ''}
                    </div>
                `;

                if (product.stock > 0) {
                    productCard.addEventListener('click', () => addToCart(product));
                }

                productGrid.appendChild(productCard);
            });
        }

        /**
         * Gets the icon for a given category ID.
         * @param {string} categoryId - The ID of the category.
         * @returns {string} The icon string.
         */
        function getCategoryIcon(categoryId) {
            if (!categoryId) return 'üì¶';

            const category = categories.find(c => c.id === categoryId);
            return category ? category.icon : 'üì¶';
        }

        /**
         * Gets the name for a given category ID.
         * @param {string} categoryId - The ID of the category.
         * @returns {string} The category name.
         */
        function getCategoryName(categoryId) {
            if (!categoryId) return 'Sin categor√≠a';

            const category = categories.find(c => c.id === categoryId);
            return category ? category.name : 'Sin categor√≠a';
        }

        /**
         * Gets the name for a given supplier ID.
         * @param {string} supplierId - The ID of the supplier.
         * @returns {string} The supplier name.
         */
        function getSupplierName(supplierId) {
            if (!supplierId) return '';

            const supplier = suppliers.find(s => s.id === supplierId);
            return supplier ? supplier.name : '';
        }

        /** Loads and displays products in the products management table. */
        function loadProductsTable() {
            const tbody = document.getElementById('products-table-body');
            tbody.innerHTML = '';

            // Sort products
            let sortedProducts = [...products];
            sortedProducts.sort((a, b) => {
                let aValue, bValue;

                switch (sortBy) {
                    case 'name':
                        aValue = a.name.toLowerCase();
                        bValue = b.name.toLowerCase();
                        break;
                    case 'code':
                        aValue = a.code;
                        bValue = b.code;
                        break;
                    case 'price':
                        aValue = a.price;
                        bValue = b.price;
                        break;
                    case 'stock':
                        aValue = a.stock;
                        bValue = b.stock;
                        break;
                    case 'category':
                        aValue = getCategoryName(a.category).toLowerCase();
                        bValue = getCategoryName(b.category).toLowerCase();
                        break;
                    default:
                        aValue = a.name.toLowerCase();
                        bValue = b.name.toLowerCase();
                }

                if (sortOrder === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });

            document.getElementById('products-count').textContent = `${sortedProducts.length} productos`;

            if (sortedProducts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 2rem;">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="fas fa-box-open"></i></div>
                                <div class="empty-state-title">No hay productos registrados</div>
                                <div class="empty-state-description">
                                    Comienza agregando tu primer producto
                                </div>
                                <button class="btn btn-primary" onclick="openModal('product-modal')">
                                    <i class="fas fa-plus-circle"></i> Agregar Producto
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            sortedProducts.forEach(product => {
                const row = document.createElement('tr');

                let statusBadge = '';
                if (product.status === 'inactive') {
                    statusBadge = '<span class="badge badge-danger">Inactivo</span>';
                } else if (product.status === 'discontinued') {
                    statusBadge = '<span class="badge badge-warning">Descontinuado</span>';
                } else if (product.stock === 0) {
                    statusBadge = '<span class="badge badge-danger">Sin Stock</span>';
                } else if (product.stock <= (product.minStock || 5)) {
                    statusBadge = '<span class="badge badge-warning">Stock Bajo</span>';
                } else {
                    statusBadge = '<span class="badge badge-success">Disponible</span>';
                }

                const categoryIcon = getCategoryIcon(product.category);
                const categoryName = getCategoryName(product.category);

                row.innerHTML = `
                    <td>${product.code}</td>
                    <td>${product.name}</td>
                    <td>${categoryIcon} ${categoryName}</td>
                    <td>${product.brand || '-'}</td>
                    <td>${product.unit || '-'}</td>
                    <td>${formatCurrency(product.price)}</td>
                    <td>${product.stock}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editProduct(${product.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Editar producto">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteProduct(${product.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Eliminar producto">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        /**
         * Adds a product to the cart.
         * @param {object} product - The product object to add.
         */
        function addToCart(product) {
            if (product.stock <= 0) {
                showNotification('error', 'Sin Stock', 'Este producto no tiene stock disponible');
                return;
            }

            const existingItem = cart.find(item => item.id === product.id);

            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity++;
                } else {
                    showNotification('warning', 'Stock Limitado', 'No hay m√°s stock disponible');
                    return;
                }
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    stock: product.stock,
                    cost: product.cost || 0, // Include cost for profitability calculation
                    taxRate: product.taxRate !== undefined ? product.taxRate : defaultTaxRate // Use product tax rate or default
                });
            }

            updateCartDisplay();
            showNotification('success', 'Producto Agregado', `${product.name} agregado al carrito`);
        }

        /** Updates the cart display and totals. */
        function updateCartDisplay() {
            const cartItems = document.getElementById('cart-items');
            const cartCount = document.getElementById('cart-count');

            cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);

            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-shopping-cart"></i></div>
                        <div class="empty-state-title">Carrito vac√≠o</div>
                        <div class="empty-state-description">
                            Agrega productos para comenzar
                        </div>
                    </div>
                `;
            } else {
                cartItems.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">${formatCurrency(item.price)} c/u</div>
                            <div class="cart-item-total">Total: ${formatCurrency(item.price * item.quantity)}</div>
                        </div>
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="updateQuantity(${item.id}, -1)">-</button>
                            <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="${item.stock}" onchange="setQuantity(${item.id}, this.value)">
                            <button class="quantity-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                        </div>
                        <button class="btn btn-danger" onclick="removeFromCart(${item.id})" style="padding: 0.25rem; font-size: 0.75rem;" title="Eliminar del carrito">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `).join('');
            }

            updateCartTotals();
        }

        /**
         * Updates the quantity of a product in the cart.
         * @param {number} productId - The ID of the product.
         * @param {number} change - The amount to change the quantity by (+1 or -1).
         */
        function updateQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;

            const newQuantity = item.quantity + change;

            if (newQuantity <= 0) {
                removeFromCart(productId);
            } else if (newQuantity <= item.stock) {
                item.quantity = newQuantity;
                updateCartDisplay();
            } else {
                showNotification('warning', 'Stock Limitado', 'No hay m√°s stock disponible');
            }
        }

        /**
         * Sets the quantity of a product in the cart directly.
         * @param {number} productId - The ID of the product.
         * @param {number} quantity - The new quantity.
         */
        function setQuantity(productId, quantity) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;

            const newQuantity = parseInt(quantity);

            if (newQuantity <= 0) {
                removeFromCart(productId);
            } else if (newQuantity <= item.stock) {
                item.quantity = newQuantity;
                updateCartDisplay();
            } else {
                showNotification('warning', 'Stock Limitado', 'Cantidad ajustada al stock disponible');
                item.quantity = item.stock;
                updateCartDisplay();
            }
        }

        /**
         * Removes a product from the cart.
         * @param {number} productId - The ID of the product to remove.
         */
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCartDisplay();
        }

        /** Updates the subtotal, tax, and total in the cart display. */
        function updateCartTotals() {
            let subtotal = 0;
            let totalTax = 0;

            cart.forEach(item => {
                const itemPrice = item.price * item.quantity;
                const itemTaxRate = item.taxRate !== undefined ? item.taxRate : defaultTaxRate;
                const itemTax = itemPrice * (itemTaxRate / 100);
                subtotal += itemPrice;
                totalTax += itemTax;
            });

            const total = subtotal + totalTax;

            document.getElementById('cart-subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('cart-tax').textContent = formatCurrency(totalTax);
            document.getElementById('cart-total').textContent = formatCurrency(total);
            document.getElementById('cart-tax-rate').textContent = defaultTaxRate; // Display default tax rate
        }

        /** Confirms and clears the cart. */
        async function clearCartConfirm() {
            if (cart.length > 0 && await customConfirm('¬øEst√°s seguro de limpiar el carrito? Todos los productos se eliminar√°n.')) {
                cart = [];
                updateCartDisplay();
                showNotification('info', 'Carrito Limpiado', 'Se han eliminado todos los productos');
            }
        }

        /** Saves the current cart as a draft in local storage. */
        function saveCartDraft() {
            if (cart.length === 0) {
                showNotification('warning', 'Carrito Vac√≠o', 'No hay productos para guardar');
                return;
            }

            const draft = {
                cart: [...cart],
                customer: document.getElementById('customer-name-sale').value,
                paymentMethod: selectedPaymentMethod,
                timestamp: new Date().toISOString()
            };

            localStorage.setItem('cartDraft', JSON.stringify(draft));
            showNotification('success', 'Borrador Guardado', 'El carrito se ha guardado como borrador');
        }

        /** Loads a saved cart draft from local storage. */
        async function loadCartDraft() {
            const draft = localStorage.getItem('cartDraft');
            if (!draft) {
                showNotification('info', 'Sin Borradores', 'No hay borradores guardados');
                return;
            }

            if (cart.length > 0 && !(await customConfirm('¬øReemplazar el carrito actual con el borrador? El carrito actual se perder√°.'))) {
                return;
            }

            try {
                const draftData = JSON.parse(draft);
                cart = draftData.cart || [];
                document.getElementById('customer-name-sale').value = draftData.customer || '';
                selectedPaymentMethod = draftData.paymentMethod || 'cash';

                // Update payment method selection
                document.querySelectorAll('.payment-btn').forEach(btn => {
                    btn.classList.remove('selected');
                    if (btn.getAttribute('data-method') === selectedPaymentMethod) {
                        btn.classList.add('selected');
                    }
                });

                updateCartDisplay();
                showNotification('success', 'Borrador Cargado', 'El borrador se ha cargado exitosamente');
            } catch (error) {
                console.error('Error loading cart draft:', error);
                showNotification('error', 'Error', 'No se pudo cargar el borrador');
            }
        }

        /** Processes the sale, initiating payment or completing directly. */
        function processSale() {
            if (cart.length === 0) {
                showNotification('warning', 'Carrito Vac√≠o', 'Agrega productos antes de procesar la venta');
                return;
            }

            const total = parseFloat(document.getElementById('cart-total').textContent.replace(currencySymbol, ''));

            if (selectedPaymentMethod === 'cash') {
                document.getElementById('cash-total').textContent = formatCurrency(total);
                document.getElementById('cash-received').value = '';
                document.getElementById('cash-change').textContent = `Cambio: ${formatCurrency(0)}`;
                document.getElementById('confirm-cash-btn').disabled = true;
                openModal('cash-payment-modal');
                // Focus on cash received input
                setTimeout(() => {
                    document.getElementById('cash-received').focus();
                }, 300);
            } else {
                completeSale(total, selectedPaymentMethod);
            }
        }

        /** Calculates and displays the change for cash payments. */
        function calculateChange() {
            const total = parseFloat(document.getElementById('cash-total').textContent.replace(currencySymbol, ''));
            const received = parseFloat(document.getElementById('cash-received').value) || 0;
            const change = received - total;

            document.getElementById('cash-change').textContent = `Cambio: ${formatCurrency(change)}`;
            document.getElementById('confirm-cash-btn').disabled = change < 0;

            // Change color based on amount
            const changeElement = document.getElementById('cash-change');
            if (change < 0) {
                changeElement.style.color = 'var(--danger-color)';
            } else if (change === 0) {
                changeElement.style.color = 'var(--success-color)';
            } else {
                changeElement.style.color = 'var(--primary-color)';
            }
        }

        /** Completes the cash payment process. */
        function completeCashPayment() {
            const total = parseFloat(document.getElementById('cash-total').textContent.replace(currencySymbol, ''));
            closeModal('cash-payment-modal');
            completeSale(total, 'cash');
        }

        /**
         * Finalizes a sale, updates stock, saves data, and generates a receipt.
         * @param {number} total - The total amount of the sale.
         * @param {string} paymentMethod - The payment method used.
         */
        function completeSale(total, paymentMethod) {
            // Calculate total cost of items sold in this transaction
            let totalCostOfItems = 0;
            cart.forEach(cartItem => {
                totalCostOfItems += (cartItem.cost || 0) * cartItem.quantity;
            });

            // Create sale record
            const sale = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('es-AR'),
                customer: document.getElementById('customer-name-sale').value || 'Cliente General',
                items: [...cart],
                subtotal: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                tax: total - cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                total: total,
                totalCost: totalCostOfItems, // Store total cost for profitability
                paymentMethod: paymentMethod,
                status: 'completed'
            };

            // Update product stock
            cart.forEach(cartItem => {
                const product = products.find(p => p.id === cartItem.id);
                if (product) {
                    product.stock -= cartItem.quantity;
                }
            });

            // Save data
            sales.push(sale);
            localStorage.setItem('sales', JSON.stringify(sales));
            localStorage.setItem('products', JSON.stringify(products));

            // Generate receipt
            generateReceipt(sale);

            // Clear cart and reset
            cart = [];
            document.getElementById('customer-name-sale').value = '';
            updateCartDisplay();
            loadProducts();
            updateDashboard();
            updateReportStatistics(); // Update stats after sale
            if (notifyLowStock) {
                checkLowStock(); // Re-check low stock after sale
            }

            showNotification('success', 'Venta Completada', `Venta por ${formatCurrency(total)} procesada exitosamente`);
        }

        /**
         * Generates and displays a sales receipt.
         * @param {object} sale - The sale object to generate a receipt for.
         */
        function generateReceipt(sale) {
            const businessInfo = JSON.parse(localStorage.getItem('businessInfo')) || {};
            const receiptContent = document.getElementById('receipt-content');

            receiptContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 1rem;">
                    <h3><i class="fas fa-store"></i> ${businessInfo.name || 'KIOSCO POS'}</h3>
                    ${businessInfo.address ? `<p>${businessInfo.address}</p>` : ''}
                    ${businessInfo.phone ? `<p>Tel: ${businessInfo.phone}</p>` : ''}
                    <p>Ticket de Venta</p>
                    <p>Fecha: ${formatDate(sale.date)} ${sale.time}</p>
                    <p>ID: #${sale.id}</p>
                </div>
                
                <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 0.5rem 0; margin: 1rem 0;">
                    <p><strong>Cliente:</strong> ${sale.customer}</p>
                </div>
                
                <div style="margin: 1rem 0;">
                    ${sale.items.map(item => `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>${item.name}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #666;">
                            <span>${item.quantity} x ${formatCurrency(item.price)}</span>
                            <span>${formatCurrency(item.quantity * item.price)}</span>
                        </div>
                    `).join('')}
                </div>
                
                <div style="border-top: 1px dashed #000; padding-top: 0.5rem; margin-top: 1rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Subtotal:</span>
                        <span>${formatCurrency(sale.subtotal)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>IVA:</span>
                        <span>${formatCurrency(sale.tax)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1rem; border-top: 1px solid #000; padding-top: 0.25rem; margin-top: 0.25rem;">
                        <span>TOTAL:</span>
                        <span>${formatCurrency(sale.total)}</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 1rem; font-size: 0.8rem;">
                    <p>M√©todo de Pago: ${getPaymentMethodName(sale.paymentMethod)}</p>
                    <p style="margin-top: 1rem;">¬°Gracias por su compra!</p>
                    <p>Vuelva pronto</p>
                </div>
            `;

            openModal('receipt-modal');
        }

        /**
         * Gets the user-friendly name for a payment method.
         * @param {string} method - The internal method key.
         * @returns {string} The display name.
         */
        function getPaymentMethodName(method) {
            const methods = {
                'cash': 'Efectivo',
                'card': 'Tarjeta',
                'transfer': 'Transferencia'
            };
            return methods[method] || method;
        }

        /** Prints the current receipt. */
        function printReceipt() {
            const receiptContent = document.getElementById('receipt-content').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Ticket de Venta</title>
                        <style>
                            body { font-family: 'Courier New', monospace; font-size: 12px; margin: 0; padding: 20px; }
                            @media print { body { margin: 0; padding: 10px; } }
                        </style>
                    </head>
                    <body>${receiptContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        /**
         * Searches products based on a query and updates the product grid and suggestions.
         * @param {Event} event - The keyup event from the search input.
         */
        function searchProducts(event) {
            const query = event.target.value.toLowerCase();
            const suggestions = document.getElementById('search-suggestions');

            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            if (query.length < 2) {
                suggestions.style.display = 'none';
                loadProducts(); // Show all products
                return;
            }

            // Debounce search
            searchTimeout = setTimeout(() => {
                const matches = products.filter(product =>
                    product.name.toLowerCase().includes(query) ||
                    product.code.includes(query) ||
                    (product.description && product.description.toLowerCase().includes(query)) ||
                    (product.brand && product.brand.toLowerCase().includes(query)) || // Search by brand
                    (product.unit && product.unit.toLowerCase().includes(query)) || // Search by unit
                    getCategoryName(product.category).toLowerCase().includes(query)
                ).slice(0, 8); // Limit suggestions

                if (matches.length > 0) {
                    suggestions.innerHTML = matches.map(product => {
                        const stockStatus = product.stock === 0 ? '‚ùå Sin stock' :
                            product.stock <= (product.minStock || 5) ? '‚ö†Ô∏è Stock bajo' :
                            '‚úÖ Disponible';

                        return `
                            <div class="search-suggestion" onclick="addToCart(${JSON.stringify(product).replace(/"/g, '&quot;')})">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${product.name}</strong><br>
                                        <small>C√≥digo: ${product.code} - ${formatCurrency(product.price)}</small>
                                    </div>
                                    <div style="text-align: right; font-size: 0.75rem;">
                                        ${stockStatus}<br>
                                        <small>Stock: ${product.stock}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    suggestions.style.display = 'block';

                    // Also filter the product grid
                    filterProductGrid(matches);
                } else {
                    suggestions.innerHTML = `
                        <div class="search-suggestion" style="text-align: center; color: var(--secondary-color);">
                            No se encontraron productos
                        </div>
                    `;
                    suggestions.style.display = 'block';
                    filterProductGrid([]);
                }
            }, 300);
        }

        /**
         * Filters and displays products in the product grid.
         * @param {Array<object>} filteredProducts - The array of products to display.
         */
        function filterProductGrid(filteredProducts) {
            const productGrid = document.getElementById('product-grid');
            productGrid.innerHTML = '';

            if (filteredProducts.length === 0) {
                productGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-search"></i></div>
                        <div class="empty-state-title">No se encontraron productos</div>
                        <div class="empty-state-description">
                            Intenta con otros t√©rminos de b√∫squeda o filtros
                        </div>
                    </div>
                `;
                return;
            }

            filteredProducts.forEach(product => {
                if (product.status === 'inactive') return;

                const productCard = document.createElement('div');
                productCard.className = 'product-card';

                if (product.stock === 0) {
                    productCard.classList.add('out-of-stock');
                } else if (product.stock <= (product.minStock || 5)) {
                    productCard.classList.add('low-stock');
                }

                const categoryIcon = getCategoryIcon(product.category);

                productCard.innerHTML = `
                    <div class="product-image">${categoryIcon}</div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">${formatCurrency(product.price)}</div>
                    <div class="product-stock">Stock: ${product.stock}</div>
                    <div class="product-hover-card">
                        <h5>${product.name}</h5>
                        ${product.brand ? `<p><strong>Marca:</strong> ${product.brand}</p>` : ''}
                        ${product.unit ? `<p><strong>Unidad:</strong> ${product.unit}</p>` : ''}
                        ${product.description ? `<p>${product.description}</p>` : ''}
                    </div>
                `;

                if (product.stock > 0) {
                    productCard.addEventListener('click', () => addToCart(product));
                }

                productGrid.appendChild(productCard);
            });
        }

        /**
         * Clears the value of a specified input field.
         * @param {string} inputId - The ID of the input field to clear.
         */
        function clearSearch(inputId) {
            document.getElementById(inputId).value = '';
            if (inputId === 'product-search') {
                document.getElementById('search-suggestions').style.display = 'none';
                loadProducts(); // Reload all products when search is cleared
            } else if (inputId === 'customer-search') {
                loadCustomers(); // Reload all customers
            }
        }

        /**
         * Opens a modal by adding the 'active' class.
         * @param {string} modalId - The ID of the modal to open.
         */
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');

            // Reset form if it's the product modal
            if (modalId === 'product-modal' && !currentEditingProduct) {
                document.getElementById('product-form').reset();
                document.getElementById('product-status').value = 'active';
                document.getElementById('product-min-stock').value = '5';
                document.getElementById('product-tax-rate').value = defaultTaxRate; // Set default IVA
                document.getElementById('product-brand').value = ''; // Clear brand
                document.getElementById('product-unit').value = ''; // Clear unit

                // Generate automatic barcode
                generateBarcode();

                // Reset manual mode
                isManualCodeMode = false;
                document.getElementById('product-code').readOnly = true;
                document.getElementById('manual-code-btn').innerHTML = '<i class="fas fa-pencil-alt"></i>';
                document.getElementById('manual-code-btn').title = 'Editar manualmente';

                // Hide new category/supplier inputs
                document.getElementById('new-category-container').style.display = 'none';
                document.getElementById('new-supplier-input').style.display = 'none';

                // Clear error states
                document.querySelectorAll('.input.error').forEach(input => {
                    input.classList.remove('error');
                });
                document.querySelectorAll('.error-message.show').forEach(error => {
                    error.classList.remove('show');
                });
            }

            // Load bulk products if bulk actions modal
            if (modalId === 'bulk-actions-modal') {
                loadBulkProducts();

                // Add event listeners for bulk actions
                document.getElementById('bulk-action').addEventListener('change', function() {
                    const action = this.value;
                    const paramsContainer = document.getElementById('bulk-action-params');

                    if (action === 'update-price') {
                        paramsContainer.innerHTML = `
                            <div class="form-group">
                                <label class="form-label">Tipo de cambio:</label>
                                <select class="input" id="bulk-price-type">
                                    <option value="percentage">Porcentaje (%)</option>
                                    <option value="fixed">Monto fijo (${currencySymbol})</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Valor:</label>
                                <input type="number" class="input" id="bulk-price-value" step="0.01" placeholder="0.00">
                            </div>
                        `;
                        paramsContainer.style.display = 'block';
                    } else if (action === 'update-stock') {
                        paramsContainer.innerHTML = `
                            <div class="form-group">
                                <label class="form-label">Tipo de actualizaci√≥n:</label>
                                <select class="input" id="bulk-stock-type">
                                    <option value="add">Agregar al stock actual</option>
                                    <option value="set">Establecer stock fijo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cantidad:</label>
                                <input type="number" class="input" id="bulk-stock-value" min="0" placeholder="0">
                            </div>
                        `;
                        paramsContainer.style.display = 'block';
                    } else if (action === 'change-category') {
                        paramsContainer.innerHTML = `
                            <div class="form-group">
                                <label class="form-label">Nueva categor√≠a:</label>
                                <select class="input" id="bulk-category-value">
                                    <option value="">Sin categor√≠a</option>
                                    ${categories.map(cat => `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`).join('')}
                                </select>
                            </div>
                        `;
                        paramsContainer.style.display = 'block';
                    } else if (action === 'change-status') {
                        paramsContainer.innerHTML = `
                            <div class="form-group">
                                <label class="form-label">Nuevo estado:</label>
                                <select class="input" id="bulk-status-value">
                                    <option value="active">‚úÖ Activo</option>
                                    <option value="inactive">‚ùå Inactivo</option>
                                    <option value="discontinued">üö´ Descontinuado</option>
                                </select>
                            </div>
                        `;
                        paramsContainer.style.display = 'block';
                    } else {
                        paramsContainer.style.display = 'none';
                    }

                    updateBulkActionButton();
                });

                // Add event listeners for checkboxes
                document.addEventListener('change', function(e) {
                    if (e.target.classList.contains('bulk-product-checkbox')) {
                        updateBulkActionButton();
                    }
                });
            }
        }

        /**
         * Closes a modal by removing the 'active' class.
         * @param {string} modalId - The ID of the modal to close.
         */
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');

            if (modalId === 'product-modal') {
                currentEditingProduct = null;
            } else if (modalId === 'category-modal') { // New: Reset category editing state
                currentEditingCategory = null;
            }
        }

        /** Closes all active modals. */
        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            currentEditingProduct = null;
            currentEditingCategory = null; // New: Reset category editing state
        }

        /**
         * Saves a product (add new or edit existing).
         * @param {Event} event - The form submission event.
         */
        async function saveProduct(event) {
            event.preventDefault();

            if (!validateProductForm()) {
                showNotification('error', 'Formulario Incompleto', 'Por favor completa todos los campos obligatorios');
                return;
            }

            toggleSpinner('product-save-spinner', true);

            const code = document.getElementById('product-code').value.trim();
            const name = document.getElementById('product-name').value.trim();
            const description = document.getElementById('product-description').value.trim();
            const brand = document.getElementById('product-brand').value.trim(); // New: Get brand
            const unit = document.getElementById('product-unit').value.trim(); // New: Get unit
            const cost = parseFloat(document.getElementById('product-cost').value) || 0;
            const price = parseFloat(document.getElementById('product-price').value);
            const stock = parseInt(document.getElementById('product-stock').value);
            const minStock = parseInt(document.getElementById('product-min-stock').value) || 5;
            const taxRate = parseFloat(document.getElementById('product-tax-rate').value) || defaultTaxRate;
            const location = document.getElementById('product-location').value.trim();
            const expiry = document.getElementById('product-expiry').value;
            const status = document.getElementById('product-status').value;

            // Handle category
            let categoryId = document.getElementById('product-category').value;
            const newCategoryInput = document.getElementById('new-category-input');

            if (categoryId === '__new__' && newCategoryInput.value.trim()) {
                // Create new category
                const selectedIcon = document.getElementById('category-icon-select').value;
                const newCategory = {
                    id: 'cat_' + Date.now(),
                    name: newCategoryInput.value.trim(),
                    icon: selectedIcon,
                    createdAt: new Date().toISOString()
                };
                categories.push(newCategory);
                localStorage.setItem('categories', JSON.stringify(categories));
                categoryId = newCategory.id;
                loadCategories();
                loadCategoriesTable(); // Update categories table
                showNotification('success', 'Categor√≠a Creada', `Nueva categor√≠a "${newCategory.name}" agregada`);
            } else if (categoryId === '__new__' && !newCategoryInput.value.trim()) {
                showNotification('error', 'Error', 'El nombre de la nueva categor√≠a es obligatorio.');
                toggleSpinner('product-save-spinner', false);
                return;
            }


            // Handle supplier
            let supplierId = document.getElementById('product-supplier').value;
            const newSupplierInput = document.getElementById('new-supplier-input');

            if (supplierId === '__new__' && newSupplierInput.value.trim()) {
                // Create new supplier
                const newSupplier = {
                    id: 'sup_' + Date.now(),
                    name: newSupplierInput.value.trim(),
                    createdAt: new Date().toISOString()
                };
                suppliers.push(newSupplier);
                localStorage.setItem('suppliers', JSON.stringify(suppliers));
                supplierId = newSupplier.id;
                loadSuppliers();
                showNotification('success', 'Proveedor Creado', `Nuevo proveedor "${newSupplier.name}" agregado`);
            } else if (supplierId === '__new__' && !newSupplierInput.value.trim()) {
                showNotification('error', 'Error', 'El nombre del nuevo proveedor es obligatorio.');
                toggleSpinner('product-save-spinner', false);
                return;
            }

            // Check if code already exists (except when editing)
            const existingProduct = products.find(p => p.code === code && p.id !== currentEditingProduct);
            if (existingProduct) {
                showNotification('error', 'C√≥digo Duplicado', 'Ya existe un producto con este c√≥digo');
                document.getElementById('product-code').classList.add('error');
                document.getElementById('code-error').textContent = 'Este c√≥digo ya existe';
                document.getElementById('code-error').classList.add('show');
                toggleSpinner('product-save-spinner', false);
                return;
            }

            if (currentEditingProduct) {
                // Edit existing product
                const productIndex = products.findIndex(p => p.id === currentEditingProduct);
                products[productIndex] = {
                    ...products[productIndex],
                    code,
                    name,
                    category: categoryId,
                    description,
                    brand, // Save brand
                    unit, // Save unit
                    cost,
                    price,
                    stock,
                    minStock,
                    taxRate,
                    supplier: supplierId,
                    location,
                    expiry,
                    status,
                    updatedAt: new Date().toISOString()
                };
                showNotification('success', 'Producto Actualizado', 'El producto ha sido actualizado exitosamente');
            } else {
                // Add new product
                const newProduct = {
                    id: Date.now(),
                    code,
                    name,
                    category: categoryId,
                    description,
                    brand, // Save brand
                    unit, // Save unit
                    cost,
                    price,
                    stock,
                    minStock,
                    taxRate,
                    supplier: supplierId,
                    location,
                    expiry,
                    status,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                products.push(newProduct);
                showNotification('success', 'Producto Agregado', 'El producto ha sido agregado exitosamente');
            }

            localStorage.setItem('products', JSON.stringify(products));
            loadProducts();
            loadProductsTable();
            updateDashboard();
            loadCategoryFilters(); // Update category filter dropdown
            closeModal('product-modal');

            // Reset form
            document.getElementById('product-form').reset();
            currentEditingProduct = null;
            toggleSpinner('product-save-spinner', false);
        }

        /**
         * Edits an existing product by populating the product modal with its data.
         * @param {number} productId - The ID of the product to edit.
         */
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('error', 'Error', 'Producto no encontrado.');
                return;
            }

            currentEditingProduct = productId;

            // Enable manual code mode for editing
            isManualCodeMode = true;
            document.getElementById('product-code').readOnly = false;
            document.getElementById('manual-code-btn').innerHTML = '<i class="fas fa-lock"></i>';
            document.getElementById('manual-code-btn').title = 'Bloquear edici√≥n';

            document.getElementById('product-code').value = product.code || '';
            document.getElementById('product-name').value = product.name || '';
            document.getElementById('product-category').value = product.category || '';
            document.getElementById('product-description').value = product.description || '';
            document.getElementById('product-brand').value = product.brand || ''; // Load brand
            document.getElementById('product-unit').value = product.unit || ''; // Load unit
            document.getElementById('product-cost').value = product.cost || '';
            document.getElementById('product-price').value = product.price || '';
            document.getElementById('product-stock').value = product.stock || '';
            document.getElementById('product-min-stock').value = product.minStock || 5;
            document.getElementById('product-tax-rate').value = product.taxRate !== undefined ? product.taxRate : defaultTaxRate; // Load product-specific tax rate
            document.getElementById('product-supplier').value = product.supplier || '';
            document.getElementById('product-location').value = product.location || '';
            document.getElementById('product-expiry').value = product.expiry || '';
            document.getElementById('product-status').value = product.status || 'active';

            // Hide new inputs
            document.getElementById('new-category-container').style.display = 'none';
            document.getElementById('new-supplier-input').style.display = 'none';

            calculateMargin();
            openModal('product-modal');
        }

        /**
         * Deletes a product after confirmation.
         * @param {number} productId - The ID of the product to delete.
         */
        async function deleteProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('error', 'Error', 'Producto no encontrado.');
                return;
            }

            if (await customConfirm(`¬øEst√°s seguro de que quieres eliminar "${product.name}"? Esta acci√≥n es irreversible.`)) {
                products = products.filter(p => p.id !== productId);
                localStorage.setItem('products', JSON.stringify(products));
                loadProducts();
                loadProductsTable();
                updateDashboard();
                showNotification('success', 'Producto Eliminado', 'El producto ha sido eliminado exitosamente');
            }
        }

        /** Updates the dashboard statistics (sales, transactions, stock). */
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todaySales = sales.filter(sale => sale.date === today && sale.status === 'completed');

            const totalSalesToday = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            const totalTransactionsToday = todaySales.length;

            // Calculate average for last 7 days (excluding today)
            const sevenDaysAgo = getDateNDaysAgo(7);
            const recentSales = sales.filter(sale => sale.date >= sevenDaysAgo && sale.date !== today && sale.status === 'completed');

            let avgDailySales = 0;
            let avgDailyTransactions = 0;

            if (recentSales.length > 0) {
                const salesByDate = recentSales.reduce((acc, sale) => {
                    acc[sale.date] = (acc[sale.date] || 0) + sale.total;
                    return acc;
                }, {});
                const transactionsByDate = recentSales.reduce((acc, sale) => {
                    acc[sale.date] = (acc[sale.date] || 0) + 1;
                    return acc;
                }, {});

                const uniqueDates = new Set(recentSales.map(sale => sale.date)).size;
                avgDailySales = Object.values(salesByDate).reduce((a, b) => a + b, 0) / uniqueDates;
                avgDailyTransactions = Object.values(transactionsByDate).reduce((a, b) => a + b, 0) / uniqueDates;
            }

            // Calculate percentage change
            let salesChange = 'N/A';
            let transactionsChange = 'N/A';
            let salesChangeClass = '';
            let transactionsChangeClass = '';

            if (avgDailySales > 0) {
                const change = ((totalSalesToday - avgDailySales) / avgDailySales * 100).toFixed(1);
                salesChange = `${change > 0 ? '+' : ''}${change}%`;
                salesChangeClass = change > 0 ? 'positive' : (change < 0 ? 'negative' : '');
            } else if (totalSalesToday > 0) {
                salesChange = '+100%';
                salesChangeClass = 'positive';
            }

            if (avgDailyTransactions > 0) {
                const change = ((totalTransactionsToday - avgDailyTransactions) / avgDailyTransactions * 100).toFixed(1);
                transactionsChange = `${change > 0 ? '+' : ''}${change}%`;
                transactionsChangeClass = change > 0 ? 'positive' : (change < 0 ? 'negative' : '');
            } else if (totalTransactionsToday > 0) {
                transactionsChange = '+100%';
                transactionsChangeClass = 'positive';
            }


            const lowStockProducts = products.filter(p => p.stock <= (p.minStock || 5) && p.status === 'active').length;
            const totalProducts = products.filter(p => p.status === 'active').length;

            document.getElementById('today-sales').textContent = formatCurrency(totalSalesToday);
            document.getElementById('today-transactions').textContent = totalTransactionsToday;
            document.getElementById('low-stock-count').textContent = lowStockProducts;
            document.getElementById('total-products').textContent = totalProducts;

            document.getElementById('today-sales-change').innerHTML = `<span><i class="fas fa-arrow-${parseFloat(salesChange) > 0 ? 'up' : (parseFloat(salesChange) < 0 ? 'down' : 'right')}"></i></span> ${salesChange}`;
            document.getElementById('today-sales-change').className = `stat-change ${salesChangeClass}`;

            document.getElementById('today-transactions-change').innerHTML = `<span><i class="fas fa-arrow-${parseFloat(transactionsChange) > 0 ? 'up' : (parseFloat(transactionsChange) < 0 ? 'down' : 'right')}"></i></span> ${transactionsChange}`;
            document.getElementById('today-transactions-change').className = `stat-change ${transactionsChangeClass}`;


            // Update top products
            updateTopProducts();
        }

        /** Updates the list of top-selling products on the dashboard. */
        function updateTopProducts() {
            const topProductsContainer = document.getElementById('top-products');

            if (sales.length === 0) {
                topProductsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-chart-bar"></i></div>
                        <div class="empty-state-title">No hay datos disponibles</div>
                        <div class="empty-state-description">
                            Realiza algunas ventas para ver estad√≠sticas
                        </div>
                    </div>
                `;
                return;
            }

            // Calculate product sales
            const productSales = {};
            sales.forEach(sale => {
                if (sale.status !== 'completed') return; // Only count completed sales
                sale.items.forEach(item => {
                    if (!productSales[item.id]) {
                        productSales[item.id] = {
                            name: item.name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    productSales[item.id].quantity += item.quantity;
                    productSales[item.id].revenue += item.quantity * item.price;
                });
            });

            // Sort by quantity sold
            const topProducts = Object.values(productSales)
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 5);

            if (topProducts.length === 0) {
                topProductsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-chart-bar"></i></div>
                        <div class="empty-state-title">No hay datos disponibles</div>
                        <div class="empty-state-description">
                            Realiza algunas ventas para ver estad√≠sticas
                        </div>
                    </div>
                `;
                return;
            }

            topProductsContainer.innerHTML = topProducts.map((product, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid var(--border-color);">
                    <div>
                        <div style="font-weight: 500;">${index + 1}. ${product.name}</div>
                        <div style="font-size: 0.75rem; color: var(--secondary-color);">
                            ${product.quantity} unidades - ${formatCurrency(product.revenue)}
                        </div>
                    </div>
                    <div style="font-size: 1.25rem;">
                        ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '<i class="fas fa-box"></i>'}
                    </div>
                </div>
            `).join('');
        }

        /** Loads and displays sales history in the table. */
        function loadHistory() {
            displayFilteredHistory(sales);
        }

        /** Exports product data to a CSV file. */
        function exportProducts() {
            if (products.length === 0) {
                showNotification('warning', 'Sin Datos', 'No hay productos para exportar');
                return;
            }

            const csvContent = [
                ['C√≥digo', 'Nombre', 'Categor√≠a', 'Marca', 'Unidad', 'Descripci√≥n', 'Precio Costo', 'Precio Venta', 'Stock', 'Stock M√≠nimo', 'IVA (%)', 'Proveedor', 'Ubicaci√≥n', 'Vencimiento', 'Estado'],
                ...products.map(p => [
                    p.code,
                    p.name,
                    getCategoryName(p.category) || '',
                    p.brand || '', // Export brand
                    p.unit || '', // Export unit
                    p.description || '',
                    p.cost || 0,
                    p.price,
                    p.stock,
                    p.minStock || 5,
                    p.taxRate !== undefined ? p.taxRate : defaultTaxRate,
                    getSupplierName(p.supplier) || '',
                    p.location || '',
                    p.expiry || '',
                    p.status || 'active'
                ])
            ].map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n'); // Enclose in quotes and escape

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `productos_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification('success', 'Exportaci√≥n Completa', 'Los productos han sido exportados exitosamente');
        }

        /** Generates and downloads a sales report. */
        function generateSalesReport() {
            const fromDate = document.getElementById('sales-report-from').value;
            const toDate = document.getElementById('sales-report-to').value;

            if (!fromDate || !toDate) {
                showNotification('warning', 'Fechas Requeridas', 'Selecciona las fechas para generar el reporte');
                return;
            }

            const filteredSales = sales.filter(sale =>
                sale.status === 'completed' && sale.date >= fromDate && sale.date <= toDate
            );

            if (filteredSales.length === 0) {
                showNotification('info', 'Sin Datos', 'No hay ventas en el per√≠odo seleccionado');
                return;
            }

            const totalSales = filteredSales.reduce((sum, sale) => sum + sale.total, 0);
            const totalTransactions = filteredSales.length;

            const reportContent = `
                REPORTE DE VENTAS
                Per√≠odo: ${formatDate(fromDate)} al ${formatDate(toDate)}
                
                Total de Ventas: ${formatCurrency(totalSales)}
                Total de Transacciones: ${totalTransactions}
                Promedio por Venta: ${formatCurrency(totalSales / totalTransactions)}
                
                Detalle de Ventas:
                ${filteredSales.map(sale =>
                    `${formatDate(sale.date)} ${sale.time} - ${sale.customer} - ${formatCurrency(sale.total)} - ${getPaymentMethodName(sale.paymentMethod)}`
                ).join('\n')}
            `;

            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_ventas_${fromDate}_${toDate}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification('success', 'Reporte Generado', 'El reporte de ventas ha sido descargado');
        }

        /** Generates and downloads an inventory report. */
        function generateInventoryReport() {
            if (products.length === 0) {
                showNotification('warning', 'Sin Datos', 'No hay productos para reportar');
                return;
            }

            const totalProducts = products.length;
            const activeProducts = products.filter(p => p.status === 'active');
            const lowStockProducts = products.filter(p => p.stock > 0 && p.stock <= (p.minStock || 5) && p.status === 'active');
            const outOfStockProducts = products.filter(p => p.stock === 0 && p.status === 'active');
            const totalValue = products.reduce((sum, p) => sum + (p.price * p.stock), 0);

            const reportContent = `
                REPORTE DE INVENTARIO
                Fecha: ${formatDate(new Date().toISOString().split('T')[0])}
                
                Resumen:
                Total de Productos: ${totalProducts}
                Productos Activos: ${activeProducts.length}
                Productos con Stock Bajo: ${lowStockProducts.length}
                Productos Sin Stock: ${outOfStockProducts.length}
                Valor Total del Inventario: ${formatCurrency(totalValue)}
                
                Productos con Stock Bajo:
                ${lowStockProducts.map(p =>
                    `${p.name} - Stock: ${p.stock} (M√≠nimo: ${p.minStock || 5})`
                ).join('\n')}
                
                Productos Sin Stock:
                ${outOfStockProducts.map(p => p.name).join('\n')}
                
                Inventario Completo:
                ${products.map(p =>
                    `${p.code} - ${p.name} - Stock: ${p.stock} - Precio: ${formatCurrency(p.price)} - Estado: ${p.status || 'active'}`
                ).join('\n')}
            `;

            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_inventario_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification('success', 'Reporte Generado', 'El reporte de inventario ha sido descargado');
        }

        /** Generates and downloads a financial report. */
        function generateFinancialReport() {
            if (sales.length === 0) {
                showNotification('warning', 'Sin Datos', 'No hay ventas para reportar');
                return;
            }

            const completedSales = sales.filter(sale => sale.status === 'completed');

            const totalRevenue = completedSales.reduce((sum, sale) => sum + sale.total, 0);
            const totalCostOfSales = completedSales.reduce((sum, sale) => sum + (sale.totalCost || 0), 0);
            const grossProfit = totalRevenue - totalCostOfSales;
            const profitMargin = totalRevenue > 0 ? (grossProfit / totalRevenue * 100).toFixed(2) : 0;

            const totalTransactions = completedSales.length;
            const averageTicket = totalTransactions > 0 ? totalRevenue / totalTransactions : 0;

            const paymentMethods = completedSales.reduce((acc, sale) => {
                acc[sale.paymentMethod] = (acc[sale.paymentMethod] || 0) + sale.total;
                return acc;
            }, {});

            const salesByDay = completedSales.reduce((acc, sale) => {
                acc[sale.date] = (acc[sale.date] || 0) + sale.total;
                return acc;
            }, {});

            const reportContent = `
                REPORTE FINANCIERO
                Fecha: ${formatDate(new Date().toISOString().split('T')[0])}
                
                Resumen Financiero:
                Ingresos Totales: ${formatCurrency(totalRevenue)}
                Costo Total de Ventas: ${formatCurrency(totalCostOfSales)}
                Ganancia Bruta: ${formatCurrency(grossProfit)}
                Margen de Ganancia: ${profitMargin}%
                Total de Transacciones: ${totalTransactions}
                Ticket Promedio: ${formatCurrency(averageTicket)}
                
                Por M√©todo de Pago:
                ${Object.entries(paymentMethods).map(([method, amount]) =>
                    `${getPaymentMethodName(method)}: ${formatCurrency(amount)}`
                ).join('\n')}
                
                Ventas por D√≠a:
                ${Object.entries(salesByDay).map(([date, amount]) =>
                    `${formatDate(date)}: ${formatCurrency(amount)}`
                ).join('\n')}
            `;

            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_financiero_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification('success', 'Reporte Generado', 'El reporte financiero ha sido descargado');
        }

        /** Generates and downloads a quick sales report for the current day. */
        function generateQuickReport() {
            const today = new Date().toISOString().split('T')[0];
            const todaySales = sales.filter(sale => sale.date === today && sale.status === 'completed');

            if (todaySales.length === 0) {
                showNotification('info', 'Sin Ventas', 'No hay ventas registradas hoy');
                return;
            }

            const totalSales = todaySales.reduce((sum, sale) => sum + sale.total, 0);

            const reportContent = `
                REPORTE R√ÅPIDO - ${formatDate(today)}
                
                Ventas del D√≠a: ${formatCurrency(totalSales)}
                Transacciones: ${todaySales.length}
                Promedio por Venta: ${formatCurrency(totalSales / todaySales.length)}
                
                √öltimas Ventas:
                ${todaySales.slice(-5).map(sale =>
                    `${sale.time} - ${sale.customer} - ${formatCurrency(sale.total)}`
                ).join('\n')}
            `;

            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_rapido_${today}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification('success', 'Reporte Generado', 'El reporte r√°pido ha sido descargado');
        }

        /** Loads business information from local storage and populates the configuration form. */
        function loadBusinessInfo() {
            const businessInfo = JSON.parse(localStorage.getItem('businessInfo')) || {};

            if (businessInfo.name) document.getElementById('business-name').value = businessInfo.name;
            if (businessInfo.address) document.getElementById('business-address').value = businessInfo.address;
            if (businessInfo.phone) document.getElementById('business-phone').value = businessInfo.phone;
        }

        /** Loads payment settings from local storage and populates the configuration form. */
        function loadPaymentSettings() {
            const paymentSettings = JSON.parse(localStorage.getItem('paymentSettings')) || {};

            if (paymentSettings.defaultTax !== undefined) {
                document.getElementById('default-tax').value = paymentSettings.defaultTax;
                defaultTaxRate = parseFloat(paymentSettings.defaultTax); // Update global default
            }
            if (paymentSettings.enableCash !== undefined) document.getElementById('enable-cash').checked = paymentSettings.enableCash;
            if (paymentSettings.enableCard !== undefined) document.getElementById('enable-card').checked = paymentSettings.enableCard;
            if (paymentSettings.enableTransfer !== undefined) document.getElementById('enable-transfer').checked = paymentSettings.enableTransfer;
            updateCartTotals(); // Recalculate cart totals with new default tax rate
        }

        /** Saves business information to local storage. */
        function saveBusinessInfo() {
            const businessInfo = {
                name: document.getElementById('business-name').value,
                address: document.getElementById('business-address').value,
                phone: document.getElementById('business-phone').value
            };

            localStorage.setItem('businessInfo', JSON.stringify(businessInfo));
            showNotification('success', 'Informaci√≥n Guardada', 'La informaci√≥n del negocio ha sido actualizada');
        }

        /** Saves payment settings to local storage. */
        function savePaymentSettings() {
            const newDefaultTax = parseFloat(document.getElementById('default-tax').value);
            if (isNaN(newDefaultTax) || newDefaultTax < 0 || newDefaultTax > 100) {
                showNotification('error', 'Error', 'La tasa de IVA debe ser un n√∫mero entre 0 y 100.');
                document.getElementById('default-tax').classList.add('error');
                return;
            }
            document.getElementById('default-tax').classList.remove('error');

            const paymentSettings = {
                defaultTax: newDefaultTax,
                enableCash: document.getElementById('enable-cash').checked,
                enableCard: document.getElementById('enable-card').checked,
                enableTransfer: document.getElementById('enable-transfer').checked
            };

            localStorage.setItem('paymentSettings', JSON.stringify(paymentSettings));
            defaultTaxRate = newDefaultTax; // Update global default
            updateCartTotals(); // Recalculate cart totals with new default tax rate
            showNotification('success', 'Configuraci√≥n Guardada', 'Los ajustes de pago han sido actualizados');
        }

        /** Confirms and performs the cash close operation. */
        async function confirmCashClose() {
            const today = new Date().toISOString().split('T')[0];
            const todaySales = sales.filter(sale => sale.date === today && sale.status === 'completed');

            const totalSales = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            const totalTransactions = todaySales.length;

            document.getElementById('close-total-sales').textContent = formatCurrency(totalSales);
            document.getElementById('close-total-transactions').textContent = totalTransactions;

            if (await customConfirm(`¬øEst√°s seguro de realizar el cierre de caja para hoy (${formatDate(today)})?`)) {
                const cashCloseRecord = {
                    id: Date.now(),
                    date: today,
                    totalSales: totalSales,
                    totalTransactions: totalTransactions,
                    timestamp: new Date().toISOString()
                };
                cashClosures.push(cashCloseRecord);
                localStorage.setItem('cashClosures', JSON.stringify(cashClosures));
                showNotification('success', 'Cierre Realizado', `Cierre de caja completado. Total: ${formatCurrency(totalSales)}`);
                closeModal('cash-close-modal');
            }
        }

        /** Loads categories into the sales section filter dropdown. */
        function loadCategoryFilters() {
            const categoryFilter = document.getElementById('category-filter');
            if (!categoryFilter) return;

            // Clear existing options except "all"
            while (categoryFilter.children.length > 1) {
                categoryFilter.removeChild(categoryFilter.lastChild);
            }

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = `${category.icon} ${category.name}`;
                categoryFilter.appendChild(option);
            });
        }

        /** Filters products in the sales section based on category and stock. */
        function filterProducts() {
            const categoryFilter = document.getElementById('category-filter').value;
            const stockFilter = document.getElementById('stock-filter').value;

            let filteredProducts = [...products];

            // Filter by category
            if (categoryFilter !== 'all') {
                filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
            }

            // Filter by stock status
            if (stockFilter !== 'all') {
                switch (stockFilter) {
                    case 'available':
                        filteredProducts = filteredProducts.filter(p => p.stock > (p.minStock || 5));
                        break;
                    case 'low':
                        filteredProducts = filteredProducts.filter(p => p.stock > 0 && p.stock <= (p.minStock || 5));
                        break;
                    case 'out':
                        filteredProducts = filteredProducts.filter(p => p.stock === 0);
                        break;
                }
            }

            filterProductGrid(filteredProducts);
        }

        /** Clears all filters in the sales section. */
        function clearFilters() {
            document.getElementById('category-filter').value = 'all';
            document.getElementById('stock-filter').value = 'all';
            document.getElementById('product-search').value = '';
            document.getElementById('search-suggestions').style.display = 'none';
            loadProducts();
        }

        /** Sets the product sorting criterion and reloads the product table. */
        function sortProducts() {
            sortBy = document.getElementById('sort-products').value;
            loadProductsTable();
        }

        /** Toggles the product sorting order (ascending/descending) and reloads the table. */
        function toggleSortOrder() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            document.getElementById('sort-order-btn').innerHTML = sortOrder === 'asc' ? '<i class="fas fa-sort-alpha-down"></i>' : '<i class="fas fa-sort-alpha-up"></i>';
            loadProductsTable();
        }

        /** Automatically saves application data to local storage. */
        function autoSave() {
            try {
                localStorage.setItem('products', JSON.stringify(products));
                localStorage.setItem('sales', JSON.stringify(sales));
                localStorage.setItem('categories', JSON.stringify(categories));
                localStorage.setItem('suppliers', JSON.stringify(suppliers));
                localStorage.setItem('customers', JSON.stringify(customers));
                localStorage.setItem('cashClosures', JSON.stringify(cashClosures)); // Save cash closures
                localStorage.setItem('lastSave', new Date().toISOString());
            } catch (error) {
                console.error('Error during auto-save:', error);
                showNotification('error', 'Error de Guardado', 'No se pudo guardar autom√°ticamente');
            }
        }

        /** Checks for products with low stock and displays a warning notification. */
        function checkLowStock() {
            if (!notifyLowStock) return; // Only notify if enabled

            const lowStockProducts = products.filter(p =>
                p.stock > 0 &&
                p.stock <= (p.minStock || 5) &&
                p.status === 'active'
            );

            if (lowStockProducts.length > 0) {
                setTimeout(() => {
                    showNotification('warning', 'Stock Bajo',
                        `${lowStockProducts.length} productos tienen stock bajo. ¬°Revisa tu inventario!`);
                }, 2000);
            }
        }

        /** Creates a backup of all application data and downloads it as a JSON file. */
        function createBackup() {
            const backupData = {
                products,
                sales,
                categories,
                suppliers,
                customers, // Include customers in backup
                cashClosures, // Include cash closures in backup
                businessInfo: JSON.parse(localStorage.getItem('businessInfo') || '{}'),
                paymentSettings: JSON.parse(localStorage.getItem('paymentSettings') || '{}'),
                personalizationSettings: JSON.parse(localStorage.getItem('personalizationSettings') || '{}'), // Include personalization
                timestamp: new Date().toISOString(),
                version: '1.2' // Updated version
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_pos_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);

            localStorage.setItem('lastBackup', new Date().toISOString());
            showNotification('success', 'Respaldo Creado', 'El respaldo se ha descargado exitosamente');
        }

        /** Previews the content of a selected CSV file for import. */
        function previewImport() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];

            if (!file) {
                document.getElementById('import-preview').style.display = 'none';
                document.getElementById('import-btn').disabled = true;
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());

                const preview = document.getElementById('import-preview');
                const previewContent = document.getElementById('import-preview-content');

                let previewHTML = '<table style="width: 100%; font-size: 0.75rem;"><thead><tr>';
                headers.forEach(header => {
                    previewHTML += `<th style="padding: 0.25rem; border: 1px solid var(--border-color);">${header}</th>`;
                });
                previewHTML += '</tr></thead><tbody>';

                // Show first 5 rows
                for (let i = 1; i < Math.min(6, lines.length); i++) {
                    if (lines[i].trim()) {
                        const cells = lines[i].split(',');
                        previewHTML += '<tr>';
                        cells.forEach(cell => {
                            previewHTML += `<td style="padding: 0.25rem; border: 1px solid var(--border-color);">${cell.trim()}</td>`;
                        });
                        previewHTML += '</tr>';
                    }
                }

                previewHTML += '</tbody></table>';
                previewContent.innerHTML = previewHTML;
                preview.style.display = 'block';
                document.getElementById('import-btn').disabled = false;
            };

            reader.readAsText(file);
        }

        /** Processes the import of products from a CSV file. */
        async function processImport() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];

            if (!file) return;

            toggleSpinner('import-spinner', true);

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());

                let importedCount = 0;
                let errorCount = 0;

                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;

                    const cells = lines[i].split(',');

                    try {
                        const code = cells[headers.indexOf('c√≥digo')] || generateBarcode();
                        const name = cells[headers.indexOf('nombre')];
                        const categoryName = cells[headers.indexOf('categor√≠a')] || 'Sin categor√≠a';
                        const brand = cells[headers.indexOf('marca')] || ''; // Import brand
                        const unit = cells[headers.indexOf('unidad')] || ''; // Import unit
                        const description = cells[headers.indexOf('descripci√≥n')] || '';
                        const cost = parseFloat(cells[headers.indexOf('precio costo')]) || 0;
                        const price = parseFloat(cells[headers.indexOf('precio venta')]);
                        const stock = parseInt(cells[headers.indexOf('stock')]);
                        const minStock = parseInt(cells[headers.indexOf('stock m√≠nimo')]) || 5;
                        const taxRate = parseFloat(cells[headers.indexOf('iva (%)')]) || defaultTaxRate;
                        const supplierName = cells[headers.indexOf('proveedor')] || '';
                        const location = cells[headers.indexOf('ubicaci√≥n')] || '';
                        const expiry = cells[headers.indexOf('vencimiento')] || '';
                        const status = cells[headers.indexOf('estado')] || 'active';

                        if (!name || isNaN(price) || isNaN(stock)) {
                            errorCount++;
                            continue;
                        }

                        // Check if product already exists by code
                        if (products.some(p => p.code === code)) {
                            errorCount++;
                            continue;
                        }

                        // Get or create category
                        let category = categories.find(c => c.name.toLowerCase() === categoryName.toLowerCase());
                        if (!category) {
                            category = {
                                id: 'cat_' + Date.now() + Math.random().toString(36).substring(2, 9),
                                name: categoryName,
                                icon: 'üì¶', // Default icon for new categories from import
                                createdAt: new Date().toISOString()
                            };
                            categories.push(category);
                        }

                        // Get or create supplier
                        let supplier = suppliers.find(s => s.name.toLowerCase() === supplierName.toLowerCase());
                        if (!supplier && supplierName) {
                            supplier = {
                                id: 'sup_' + Date.now() + Math.random().toString(36).substring(2, 9),
                                name: supplierName,
                                createdAt: new Date().toISOString()
                            };
                            suppliers.push(supplier);
                        }

                        const newProduct = {
                            id: Date.now() + i,
                            code: code.trim(),
                            name: name.trim(),
                            category: category ? category.id : '',
                            description: description.trim(),
                            brand: brand.trim(), // Save brand
                            unit: unit.trim(), // Save unit
                            cost,
                            price,
                            stock,
                            minStock,
                            taxRate,
                            supplier: supplier ? supplier.id : '',
                            location: location.trim(),
                            expiry: expiry.trim(),
                            status: status.trim(),
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };

                        products.push(newProduct);
                        importedCount++;

                    } catch (error) {
                        console.error('Error processing CSV row:', lines[i], error);
                        errorCount++;
                    }
                }

                localStorage.setItem('products', JSON.stringify(products));
                localStorage.setItem('categories', JSON.stringify(categories));
                localStorage.setItem('suppliers', JSON.stringify(suppliers));

                loadProducts();
                loadProductsTable();
                updateDashboard();
                loadCategoryFilters();
                loadSuppliers(); // Reload suppliers dropdown
                closeModal('import-modal');

                showNotification('success', 'Importaci√≥n Completa',
                    `${importedCount} productos importados. ${errorCount} errores.`);
                toggleSpinner('import-spinner', false);
            };

            reader.readAsText(file);
        }

        /** Loads products into the bulk actions modal for selection. */
        function loadBulkProducts() {
            const container = document.getElementById('bulk-products-list');
            container.innerHTML = products.map(product => `
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; padding: 0.25rem; border-radius: 0.25rem; cursor: pointer;"
                       onmouseover="this.style.background='var(--bg-color)'"
                       onmouseout="this.style.background='transparent'">
                    <input type="checkbox" class="bulk-product-checkbox" value="${product.id}">
                    <span style="flex: 1;">${product.name}</span>
                    <small style="color: var(--secondary-color);">${formatCurrency(product.price)}</small>
                </label>
            `).join('');
        }

        /** Toggles the selection of all products in the bulk actions modal. */
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all-products');
            const checkboxes = document.querySelectorAll('.bulk-product-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });

            updateBulkActionButton();
        }

        /** Updates the enabled state of the bulk action execution button. */
        function updateBulkActionButton() {
            const selectedProducts = document.querySelectorAll('.bulk-product-checkbox:checked');
            const action = document.getElementById('bulk-action').value;
            const executeBtn = document.getElementById('bulk-execute-btn');

            executeBtn.disabled = selectedProducts.length === 0 || !action;
        }

        /** Executes the selected bulk action on the chosen products. */
        async function executeBulkAction() {
            const selectedProductIds = Array.from(document.querySelectorAll('.bulk-product-checkbox:checked'))
                .map(cb => parseInt(cb.value));
            const action = document.getElementById('bulk-action').value;

            if (selectedProductIds.length === 0 || !action) return;

            if (!(await customConfirm(`¬øEst√°s seguro de ejecutar la acci√≥n "${action}" en ${selectedProductIds.length} productos?`))) {
                return;
            }

            toggleSpinner('bulk-action-spinner', true);
            let updatedCount = 0;

            switch (action) {
                case 'update-price':
                    const priceChange = parseFloat(document.getElementById('bulk-price-value').value);
                    const priceType = document.getElementById('bulk-price-type').value;

                    if (isNaN(priceChange)) {
                        showNotification('error', 'Error', 'Valor de precio no v√°lido.');
                        toggleSpinner('bulk-action-spinner', false);
                        return;
                    }

                    selectedProductIds.forEach(id => {
                        const product = products.find(p => p.id === id);
                        if (product) {
                            if (priceType === 'percentage') {
                                product.price *= (1 + priceChange / 100);
                            } else {
                                product.price += priceChange;
                            }
                            product.price = Math.max(0, parseFloat(product.price.toFixed(2))); // Ensure non-negative and 2 decimal places
                            updatedCount++;
                        }
                    });
                    break;

                case 'update-stock':
                    const stockChange = parseInt(document.getElementById('bulk-stock-value').value);
                    const stockType = document.getElementById('bulk-stock-type').value;

                    if (isNaN(stockChange)) {
                        showNotification('error', 'Error', 'Cantidad de stock no v√°lida.');
                        toggleSpinner('bulk-action-spinner', false);
                        return;
                    }

                    selectedProductIds.forEach(id => {
                        const product = products.find(p => p.id === id);
                        if (product) {
                            if (stockType === 'add') {
                                product.stock += stockChange;
                            } else {
                                product.stock = stockChange;
                            }
                            product.stock = Math.max(0, product.stock); // Ensure non-negative stock
                            updatedCount++;
                        }
                    });
                    break;

                case 'change-category':
                    const newCategory = document.getElementById('bulk-category-value').value;

                    selectedProductIds.forEach(id => {
                        const product = products.find(p => p.id === id);
                        if (product) {
                            product.category = newCategory;
                            updatedCount++;
                        }
                    });
                    break;

                case 'change-status':
                    const newStatus = document.getElementById('bulk-status-value').value;

                    selectedProductIds.forEach(id => {
                        const product = products.find(p => p.id === id);
                        if (product) {
                            product.status = newStatus;
                            updatedCount++;
                        }
                    });
                    break;

                case 'delete':
                    products = products.filter(p => !selectedProductIds.includes(p.id));
                    updatedCount = selectedProductIds.length;
                    break;
            }

            if (updatedCount > 0) {
                localStorage.setItem('products', JSON.stringify(products));
                loadProducts();
                loadProductsTable();
                updateDashboard();
                closeModal('bulk-actions-modal');

                showNotification('success', 'Acci√≥n Completada',
                    `${updatedCount} productos actualizados exitosamente`);
            } else {
                showNotification('info', 'Sin Cambios', 'No se realiz√≥ ninguna actualizaci√≥n.');
            }
            toggleSpinner('bulk-action-spinner', false);
        }

        // --- Category Management Functions ---

        /** Opens the category modal for adding a new category or editing an existing one. */
        function openCategoryModal(categoryId = null) {
            const categoryForm = document.getElementById('category-form');
            categoryForm.reset();
            document.getElementById('category-name').classList.remove('error');
            document.getElementById('category-name-error').classList.remove('show');
            currentEditingCategory = categoryId;

            if (categoryId) {
                const category = categories.find(c => c.id === categoryId);
                if (category) {
                    document.getElementById('category-name').value = category.name;
                    document.getElementById('category-icon').value = category.icon;
                }
            }
            openModal('category-modal');
        }

        /** Loads and displays category data in the categories table. */
        function loadCategoriesTable() {
            const tbody = document.getElementById('categories-table-body');
            if (!tbody) return;

            tbody.innerHTML = '';

            document.getElementById('categories-count').textContent = `${categories.length} categor√≠as`;

            if (categories.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 2rem;">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="fas fa-tags"></i></div>
                                <div class="empty-state-title">No hay categor√≠as registradas</div>
                                <div class="empty-state-description">
                                    Comienza agregando tu primera categor√≠a
                                </div>
                                <button class="btn btn-primary" onclick="openCategoryModal()">
                                    <i class="fas fa-plus-circle"></i> Agregar Categor√≠a
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            categories.forEach(category => {
                const productsInCategory = products.filter(p => p.category === category.id).length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category.icon}</td>
                    <td>${category.name}</td>
                    <td>${productsInCategory}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="openCategoryModal('${category.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Editar categor√≠a">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteCategory('${category.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Eliminar categor√≠a">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * Saves a category (add new or edit existing).
         * @param {Event} event - The form submission event.
         */
        async function saveCategory(event) {
            event.preventDefault();

            if (!validateCategoryForm()) {
                showNotification('error', 'Formulario Incompleto', 'Por favor completa el nombre de la categor√≠a');
                return;
            }

            toggleSpinner('category-save-spinner', true);

            const name = document.getElementById('category-name').value.trim();
            const icon = document.getElementById('category-icon').value;

            // Check for duplicate name (case-insensitive)
            const existingCategory = categories.find(c => c.name.toLowerCase() === name.toLowerCase() && c.id !== currentEditingCategory);
            if (existingCategory) {
                showNotification('error', 'Nombre Duplicado', 'Ya existe una categor√≠a con este nombre.');
                document.getElementById('category-name').classList.add('error');
                document.getElementById('category-name-error').textContent = 'Este nombre ya existe';
                document.getElementById('category-name-error').classList.add('show');
                toggleSpinner('category-save-spinner', false);
                return;
            }

            if (currentEditingCategory) {
                // Edit existing category
                const categoryIndex = categories.findIndex(c => c.id === currentEditingCategory);
                categories[categoryIndex] = {
                    ...categories[categoryIndex],
                    name,
                    icon,
                    updatedAt: new Date().toISOString()
                };
                showNotification('success', 'Categor√≠a Actualizada', 'La categor√≠a ha sido actualizada exitosamente');
            } else {
                // Add new category
                const newCategory = {
                    id: 'cat_' + Date.now(),
                    name,
                    icon,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                categories.push(newCategory);
                showNotification('success', 'Categor√≠a Agregada', 'La categor√≠a ha sido agregada exitosamente');
            }

            localStorage.setItem('categories', JSON.stringify(categories));
            loadCategories(); // Update product category dropdowns
            loadCategoriesTable(); // Update categories table
            closeModal('category-modal');
            currentEditingCategory = null;
            toggleSpinner('category-save-spinner', false);
        }

        /**
         * Deletes a category after confirmation.
         * If products are associated, it will ask to reassign them.
         * @param {string} categoryId - The ID of the category to delete.
         */
        async function deleteCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) {
                showNotification('error', 'Error', 'Categor√≠a no encontrada.');
                return;
            }

            const productsInCategory = products.filter(p => p.category === categoryId);

            if (productsInCategory.length > 0) {
                if (!(await customConfirm(`La categor√≠a "${category.name}" tiene ${productsInCategory.length} productos asociados. ¬øEst√°s seguro de eliminarla? Los productos asociados quedar√°n sin categor√≠a.`))) {
                    return;
                }
            } else {
                if (!(await customConfirm(`¬øEst√°s seguro de que quieres eliminar la categor√≠a "${category.name}"? Esta acci√≥n es irreversible.`))) {
                    return;
                }
            }

            // Remove category
            categories = categories.filter(c => c.id !== categoryId);
            localStorage.setItem('categories', JSON.stringify(categories));

            // Reassign products without category
            products.forEach(p => {
                if (p.category === categoryId) {
                    p.category = ''; // Set to empty string for "Sin categor√≠a"
                }
            });
            localStorage.setItem('products', JSON.stringify(products));

            loadCategories();
            loadCategoriesTable();
            loadProducts(); // Refresh product grid in sales
            loadProductsTable(); // Refresh product table in products
            showNotification('success', 'Categor√≠a Eliminada', `La categor√≠a "${category.name}" ha sido eliminada.`);
        }

        // --- Customer Management Functions ---

        /** Loads and displays customer data in the customers table. */
        function loadCustomers() {
            const tbody = document.getElementById('customers-table-body');
            if (!tbody) return;

            tbody.innerHTML = '';

            document.getElementById('customers-count').textContent = `${customers.length} clientes`;

            if (customers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem;">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="fas fa-users"></i></div>
                                <div class="empty-state-title">No hay clientes registrados</div>
                                <div class="empty-state-description">
                                    Comienza agregando tu primer cliente
                                </div>
                                <button class="btn btn-primary" onclick="openModal('customer-modal')">
                                    <i class="fas fa-user-plus"></i> Agregar Cliente
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            customers.forEach(customer => {
                const customerSales = sales.filter(sale => sale.customer === customer.name && sale.status === 'completed');
                const totalPurchases = customerSales.reduce((sum, sale) => sum + sale.total, 0);
                const lastPurchase = customerSales.length > 0 ?
                    formatDate(customerSales.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date) : 'Nunca';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.name}</td>
                    <td>${customer.email || '-'}</td>
                    <td>${customer.phone || '-'}</td>
                    <td>${formatCurrency(totalPurchases)}</td>
                    <td>${lastPurchase}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editCustomer(${customer.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Editar cliente">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteCustomer(${customer.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Eliminar cliente">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * Saves customer data (add new or edit existing).
         * @param {Event} event - The form submission event.
         */
        async function saveCustomer(event) {
            event.preventDefault();

            const name = document.getElementById('customer-name').value.trim();
            const email = document.getElementById('customer-email').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const birthday = document.getElementById('customer-birthday').value;
            const address = document.getElementById('customer-address').value.trim();
            const discount = parseFloat(document.getElementById('customer-discount').value) || 0;
            const creditLimit = parseFloat(document.getElementById('customer-credit-limit').value) || 0;
            const notes = document.getElementById('customer-notes').value.trim();

            if (!name) {
                showNotification('error', 'Nombre Requerido', 'El nombre del cliente es obligatorio');
                document.getElementById('customer-name').classList.add('error');
                return;
            }
            document.getElementById('customer-name').classList.remove('error');

            toggleSpinner('customer-save-spinner', true);

            if (currentEditingCustomer) {
                // Edit existing customer
                const customerIndex = customers.findIndex(c => c.id === currentEditingCustomer);
                customers[customerIndex] = {
                    ...customers[customerIndex],
                    name,
                    email,
                    phone,
                    birthday,
                    address,
                    discount,
                    creditLimit,
                    notes,
                    updatedAt: new Date().toISOString()
                };
                showNotification('success', 'Cliente Actualizado', 'El cliente ha sido actualizado exitosamente');
            } else {
                // Add new customer
                const newCustomer = {
                    id: Date.now(),
                    name,
                    email,
                    phone,
                    birthday,
                    address,
                    discount,
                    creditLimit,
                    notes,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                customers.push(newCustomer);
                showNotification('success', 'Cliente Agregado', 'El cliente ha sido agregado exitosamente');
            }

            localStorage.setItem('customers', JSON.stringify(customers));
            loadCustomers();
            closeModal('customer-modal');
            currentEditingCustomer = null;
            toggleSpinner('customer-save-spinner', false);
        }

        /**
         * Edits an existing customer by populating the customer modal with its data.
         * @param {number} customerId - The ID of the customer to edit.
         */
        function editCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                showNotification('error', 'Error', 'Cliente no encontrado.');
                return;
            }

            currentEditingCustomer = customerId;

            document.getElementById('customer-name').value = customer.name || '';
            document.getElementById('customer-email').value = customer.email || '';
            document.getElementById('customer-phone').value = customer.phone || '';
            document.getElementById('customer-birthday').value = customer.birthday || '';
            document.getElementById('customer-address').value = customer.address || '';
            document.getElementById('customer-discount').value = customer.discount || 0;
            document.getElementById('customer-credit-limit').value = customer.creditLimit || 0;
            document.getElementById('customer-notes').value = customer.notes || '';

            openModal('customer-modal');
        }

        /**
         * Deletes a customer after confirmation.
         * @param {number} customerId - The ID of the customer to delete.
         */
        async function deleteCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                showNotification('error', 'Error', 'Cliente no encontrado.');
                return;
            }

            if (await customConfirm(`¬øEst√°s seguro de que quieres eliminar a "${customer.name}"? Esta acci√≥n es irreversible.`)) {
                customers = customers.filter(c => c.id !== customerId);
                localStorage.setItem('customers', JSON.stringify(customers));
                loadCustomers();
                showNotification('success', 'Cliente Eliminado', 'El cliente ha sido eliminado exitosamente');
            }
        }

        /** Searches customers based on a query and updates the customers table. */
        function searchCustomers() {
            const query = document.getElementById('customer-search').value.toLowerCase();
            const tbody = document.getElementById('customers-table-body');

            if (query.length === 0) {
                loadCustomers();
                return;
            }

            const filteredCustomers = customers.filter(customer =>
                customer.name.toLowerCase().includes(query) ||
                (customer.email && customer.email.toLowerCase().includes(query)) ||
                (customer.phone && customer.phone.includes(query))
            );

            tbody.innerHTML = '';
            document.getElementById('customers-count').textContent = `${filteredCustomers.length} clientes`;

            if (filteredCustomers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: var(--secondary-color);">
                            No se encontraron clientes que coincidan con la b√∫squeda
                        </td>
                    </tr>
                `;
                return;
            }

            filteredCustomers.forEach(customer => {
                const customerSales = sales.filter(sale => sale.customer === customer.name && sale.status === 'completed');
                const totalPurchases = customerSales.reduce((sum, sale) => sum + sale.total, 0);
                const lastPurchase = customerSales.length > 0 ?
                    formatDate(customerSales.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date) : 'Nunca';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.name}</td>
                    <td>${customer.email || '-'}</td>
                    <td>${customer.phone || '-'}</td>
                    <td>${customer.birthday || '-'}</td>
                    <td>${formatCurrency(totalPurchases)}</td>
                    <td>${lastPurchase}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editCustomer(${customer.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteCustomer(${customer.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        /** Exports customer data to a CSV file. */
        function exportCustomers() {
            if (customers.length === 0) {
                showNotification('warning', 'Sin Datos', 'No hay clientes para exportar');
                return;
            }

            const csvContent = [
                ['Nombre', 'Email', 'Tel√©fono', 'Fecha Nacimiento', 'Direcci√≥n', 'Descuento', 'L√≠mite Cr√©dito', 'Notas'],
                ...customers.map(c => [
                    c.name,
                    c.email || '',
                    c.phone || '',
                    c.birthday || '',
                    c.address || '',
                    c.discount || 0,
                    c.creditLimit || 0,
                    c.notes || ''
                ])
            ].map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `clientes_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification('success', 'Exportaci√≥n Completa', 'Los clientes han sido exportados exitosamente');
        }

        // --- History Filter Functions ---

        /** Filters sales history based on date range and payment method. */
        function filterHistory() {
            const dateFrom = document.getElementById('history-date-from').value;
            const dateTo = document.getElementById('history-date-to').value;
            const paymentMethod = document.getElementById('history-payment-filter').value;

            currentHistoryFilters = {
                dateFrom,
                dateTo,
                paymentMethod
            };

            let filteredSales = [...sales];

            // Filter by date range
            if (dateFrom) {
                filteredSales = filteredSales.filter(sale => sale.date >= dateFrom);
            }
            if (dateTo) {
                filteredSales = filteredSales.filter(sale => sale.date <= dateTo);
            }

            // Filter by payment method
            if (paymentMethod !== 'all') {
                filteredSales = filteredSales.filter(sale => sale.paymentMethod === paymentMethod);
            }

            displayFilteredHistory(filteredSales);
        }

        /** Clears all filters in the sales history section. */
        function clearHistoryFilters() {
            document.getElementById('history-date-from').value = '';
            document.getElementById('history-date-to').value = '';
            document.getElementById('history-payment-filter').value = 'all';
            currentHistoryFilters = {
                dateFrom: '',
                dateTo: '',
                paymentMethod: 'all'
            };
            loadHistory();
        }

        /**
         * Displays a filtered list of sales in the history table.
         * @param {Array<object>} filteredSales - The sales data to display.
         */
        function displayFilteredHistory(filteredSales) {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';

            const sortedSales = filteredSales.sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));

            document.getElementById('history-count').textContent = `${sortedSales.length} transacciones`;

            const totalAmount = sortedSales.reduce((sum, sale) => sum + sale.total, 0);
            document.getElementById('history-total').textContent = formatCurrency(totalAmount);

            if (sortedSales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: var(--secondary-color);">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="fas fa-history"></i></div>
                                <div class="empty-state-title">No se encontraron transacciones</div>
                                <div class="empty-state-description">
                                    Ajusta los filtros o realiza nuevas ventas para ver el historial
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            sortedSales.forEach(sale => {
                const row = document.createElement('tr');
                let statusBadge = '';
                if (sale.status === 'completed') {
                    statusBadge = '<span class="badge badge-success">Completada</span>';
                } else if (sale.status === 'cancelled') {
                    statusBadge = '<span class="badge badge-danger">Anulada</span>';
                }

                row.innerHTML = `
                    <td>#${sale.id}</td>
                    <td>${formatDate(sale.date)} ${sale.time}</td>
                    <td>${sale.customer}</td>
                    <td>${formatCurrency(sale.total)}</td>
                    <td>${getPaymentMethodName(sale.paymentMethod)}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-info" onclick="viewSaleDetails(${sale.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Ver detalles de la venta">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${sale.status === 'completed' ? `
                        <button class="btn btn-danger" onclick="cancelSale(${sale.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Anular venta">
                            <i class="fas fa-ban"></i>
                        </button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * Cancels a sale after confirmation, restoring product stock.
         * @param {number} saleId - The ID of the sale to cancel.
         */
        async function cancelSale(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) {
                showNotification('error', 'Error', 'Venta no encontrada.');
                return;
            }

            if (sale.status === 'cancelled') {
                showNotification('info', 'Venta Ya Anulada', 'Esta venta ya ha sido anulada previamente.');
                return;
            }

            if (await customConfirm(`¬øEst√°s seguro de anular la venta #${saleId}? Esta acci√≥n restaurar√° el stock de los productos.`)) {
                // Restore product stock
                sale.items.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    if (product) {
                        product.stock += item.quantity;
                    }
                });

                // Mark sale as cancelled
                sale.status = 'cancelled';
                sale.cancelledAt = new Date().toISOString();

                localStorage.setItem('sales', JSON.stringify(sales));
                localStorage.setItem('products', JSON.stringify(products));

                loadHistory();
                loadProducts();
                updateDashboard();
                updateReportStatistics(); // Update stats after cancellation
                if (notifyLowStock) {
                    checkLowStock(); // Re-check low stock after cancellation
                }

                showNotification('warning', 'Venta Anulada', `La venta #${saleId} ha sido anulada y el stock restaurado`);
            }
        }

        // --- New Statistics Functions ---

        /** Updates all detailed statistics in the reports section. */
        function updateReportStatistics() {
            updateSalesByCategoryChart();
            updateSalesByPaymentChart();
            updateProfitabilityOverview();
            updateAverageTransactionValue(); // New stat
            updateInventoryValue(); // New stat
            updateSalesByHourChart(); // New stat
            updateSalesByDayOfWeekChart(); // New stat
        }

        /** Calculates and displays sales by category. */
        function updateSalesByCategoryChart() {
            const container = document.getElementById('sales-by-category-chart');
            container.innerHTML = '';

            const salesByCategory = {};
            let totalSales = 0;

            sales.filter(s => s.status === 'completed').forEach(sale => {
                sale.items.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    const categoryId = product ? product.category : 'unknown';
                    const categoryName = getCategoryName(categoryId);

                    if (!salesByCategory[categoryName]) {
                        salesByCategory[categoryName] = 0;
                    }
                    salesByCategory[categoryName] += item.price * item.quantity;
                    totalSales += item.price * item.quantity;
                });
            });

            const sortedCategories = Object.entries(salesByCategory).sort(([, a], [, b]) => b - a);

            if (sortedCategories.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 1rem;">
                        <div class="empty-state-icon" style="font-size: 2rem;"><i class="fas fa-chart-bar"></i></div>
                        <div class="empty-state-title" style="font-size: 1rem;">No hay datos de ventas por categor√≠a</div>
                    </div>
                `;
                return;
            }

            sortedCategories.forEach(([category, amount]) => {
                const percentage = totalSales > 0 ? (amount / totalSales * 100).toFixed(1) : 0;
                const listItem = document.createElement('li');
                listItem.className = 'chart-list-item';
                listItem.innerHTML = `
                    <span class="chart-list-item-label">${category}</span>
                    <span class="chart-list-item-value">${formatCurrency(amount)} (${percentage}%)</span>
                    <div class="chart-bar-container">
                        <div class="chart-bar" style="width: ${percentage}%;"></div>
                    </div>
                `;
                container.appendChild(listItem);
            });
        }

        /** Calculates and displays sales by payment method. */
        function updateSalesByPaymentChart() {
            const container = document.getElementById('sales-by-payment-chart');
            container.innerHTML = '';

            const salesByPaymentMethod = {};
            let totalSales = 0;

            sales.filter(s => s.status === 'completed').forEach(sale => {
                const methodName = getPaymentMethodName(sale.paymentMethod);
                if (!salesByPaymentMethod[methodName]) {
                    salesByPaymentMethod[methodName] = 0;
                }
                salesByPaymentMethod[methodName] += sale.total;
                totalSales += sale.total;
            });

            const sortedMethods = Object.entries(salesByPaymentMethod).sort(([, a], [, b]) => b - a);

            if (sortedMethods.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 1rem;">
                        <div class="empty-state-icon" style="font-size: 2rem;"><i class="fas fa-credit-card"></i></div>
                        <div class="empty-state-title" style="font-size: 1rem;">No hay datos de ventas por m√©todo de pago</div>
                    </div>
                `;
                return;
            }

            sortedMethods.forEach(([method, amount]) => {
                const percentage = totalSales > 0 ? (amount / totalSales * 100).toFixed(1) : 0;
                const listItem = document.createElement('li');
                listItem.className = 'chart-list-item';
                listItem.innerHTML = `
                    <span class="chart-list-item-label">${method}</span>
                    <span class="chart-list-item-value">${formatCurrency(amount)} (${percentage}%)</span>
                    <div class="chart-bar-container">
                        <div class="chart-bar" style="width: ${percentage}%;"></div>
                    </div>
                `;
                container.appendChild(listItem);
            });
        }

        /** Calculates and displays overall profitability metrics. */
        function updateProfitabilityOverview() {
            const completedSales = sales.filter(s => s.status === 'completed');

            const totalRevenue = completedSales.reduce((sum, sale) => sum + sale.total, 0);
            const totalCostOfSales = completedSales.reduce((sum, sale) => sum + (sale.totalCost || 0), 0);
            const grossProfit = totalRevenue - totalCostOfSales;
            const profitMargin = totalRevenue > 0 ? (grossProfit / totalRevenue * 100).toFixed(2) : 0;

            document.getElementById('total-cost-of-sales').textContent = formatCurrency(totalCostOfSales);
            document.getElementById('gross-profit').textContent = formatCurrency(grossProfit);
            document.getElementById('profit-margin').textContent = `${profitMargin}%`;
        }

        /** Calculates and displays average transaction value. */
        function updateAverageTransactionValue() {
            const completedSales = sales.filter(s => s.status === 'completed');
            const totalRevenue = completedSales.reduce((sum, sale) => sum + sale.total, 0);
            const totalTransactions = completedSales.length;
            const avgValue = totalTransactions > 0 ? totalRevenue / totalTransactions : 0;
            document.getElementById('avg-transaction-value').textContent = formatCurrency(avgValue);
        }

        /** Calculates and displays total inventory value (at cost and retail). */
        function updateInventoryValue() {
            let totalCostValue = 0;
            let totalRetailValue = 0;

            products.filter(p => p.status === 'active').forEach(product => {
                totalCostValue += (product.cost || 0) * product.stock;
                totalRetailValue += product.price * product.stock;
            });

            document.getElementById('inventory-value-cost').textContent = formatCurrency(totalCostValue);
            document.getElementById('inventory-value-retail').textContent = formatCurrency(totalRetailValue);
        }

        /** Calculates and displays sales by hour of the day. */
        function updateSalesByHourChart() {
            const container = document.getElementById('sales-by-hour-chart');
            container.innerHTML = '';

            const salesByHour = Array(24).fill(0); // 0-23 hours
            let maxSalesHour = 0;

            sales.filter(s => s.status === 'completed').forEach(sale => {
                const hour = new Date(`2000-01-01T${sale.time}`).getHours(); // Parse time string
                salesByHour[hour] += sale.total;
                if (salesByHour[hour] > maxSalesHour) {
                    maxSalesHour = salesByHour[hour];
                }
            });

            if (maxSalesHour === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 1rem;">
                        <div class="empty-state-icon" style="font-size: 2rem;"><i class="fas fa-clock"></i></div>
                        <div class="empty-state-title" style="font-size: 1rem;">No hay datos de ventas por hora</div>
                    </div>
                `;
                return;
            }

            salesByHour.forEach((amount, hour) => {
                const percentage = maxSalesHour > 0 ? (amount / maxSalesHour * 100).toFixed(1) : 0;
                const hourLabel = `${hour.toString().padStart(2, '0')}:00`;
                const listItem = document.createElement('li');
                listItem.className = 'chart-list-item';
                listItem.innerHTML = `
                    <span class="chart-list-item-label">${hourLabel}</span>
                    <span class="chart-list-item-value">${formatCurrency(amount)}</span>
                    <div class="chart-bar-container">
                        <div class="chart-bar" style="width: ${percentage}%;"></div>
                    </div>
                `;
                container.appendChild(listItem);
            });
        }

        /** Calculates and displays sales by day of the week. */
        function updateSalesByDayOfWeekChart() {
            const container = document.getElementById('sales-by-day-of-week-chart');
            container.innerHTML = '';

            const salesByDayOfWeek = Array(7).fill(0); // Sunday=0, Monday=1, ..., Saturday=6
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            let maxSalesDay = 0;

            sales.filter(s => s.status === 'completed').forEach(sale => {
                const date = new Date(sale.date);
                const day = date.getDay();
                salesByDayOfWeek[day] += sale.total;
                if (salesByDayOfWeek[day] > maxSalesDay) {
                    maxSalesDay = salesByDayOfWeek[day];
                }
            });

            if (maxSalesDay === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 1rem;">
                        <div class="empty-state-icon" style="font-size: 2rem;"><i class="fas fa-calendar-alt"></i></div>
                        <div class="empty-state-title" style="font-size: 1rem;">No hay datos de ventas por d√≠a de la semana</div>
                    </div>
                `;
                return;
            }

            salesByDayOfWeek.forEach((amount, dayIndex) => {
                const percentage = maxSalesDay > 0 ? (amount / maxSalesDay * 100).toFixed(1) : 0;
                const listItem = document.createElement('li');
                listItem.className = 'chart-list-item';
                listItem.innerHTML = `
                    <span class="chart-list-item-label">${dayNames[dayIndex]}</span>
                    <span class="chart-list-item-value">${formatCurrency(amount)}</span>
                    <div class="chart-bar-container">
                        <div class="chart-bar" style="width: ${percentage}%;"></div>
                    </div>
                `;
                container.appendChild(listItem);
            });
        }


        // --- UI Improvements ---

        /** Toggles between light and dark themes. */
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }

        /**
         * Sets the theme (light or dark).
         * @param {string} theme - The theme to set ('light' or 'dark').
         */
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            updateThemeToggleIcon(theme);
            updateThemeButtons(theme);
        }

        /**
         * Updates the theme toggle button icon based on the current theme.
         * @param {string} theme - The current theme ('light' or 'dark').
         */
        function updateThemeToggleIcon(theme) {
            const icon = document.querySelector('#theme-toggle i');
            if (theme === 'dark') {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }

        /**
         * Updates the active state of theme buttons in the personalization section.
         * @param {string} theme - The current theme ('light' or 'dark').
         */
        function updateThemeButtons(theme) {
            const lightBtn = document.getElementById('theme-light-btn');
            const darkBtn = document.getElementById('theme-dark-btn');

            if (lightBtn) {
                if (theme === 'light') {
                    lightBtn.classList.add('btn-primary');
                    lightBtn.classList.remove('btn-outline');
                } else {
                    lightBtn.classList.remove('btn-primary');
                    lightBtn.classList.add('btn-outline');
                }
            }
            if (darkBtn) {
                if (theme === 'dark') {
                    darkBtn.classList.add('btn-primary');
                    darkBtn.classList.remove('btn-outline');
                } else {
                    darkBtn.classList.remove('btn-primary');
                    darkBtn.classList.add('btn-outline');
                }
            }
        }

        /** Loads personalization settings from local storage. */
        function loadPersonalizationSettings() {
            const settings = JSON.parse(localStorage.getItem('personalizationSettings') || '{}');
            currencySymbol = settings.currencySymbol !== undefined ? settings.currencySymbol : '$';
            notifyLowStock = settings.notifyLowStock !== undefined ? settings.notifyLowStock : true;

            const currencyInput = document.getElementById('currency-symbol');
            if (currencyInput) currencyInput.value = currencySymbol;

            const notifyCheckbox = document.getElementById('notify-low-stock');
            if (notifyCheckbox) notifyCheckbox.checked = notifyLowStock;

            // Update theme buttons based on loaded theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            updateThemeButtons(savedTheme);
        }

        /** Saves personalization settings to local storage. */
        function savePersonalizationSettings() {
            const newCurrencySymbol = document.getElementById('currency-symbol').value.trim();
            const newNotifyLowStock = document.getElementById('notify-low-stock').checked;

            if (!newCurrencySymbol) {
                showNotification('error', 'Error', 'El s√≠mbolo de moneda no puede estar vac√≠o.');
                document.getElementById('currency-symbol').classList.add('error');
                return;
            }
            document.getElementById('currency-symbol').classList.remove('error');

            const settings = {
                currencySymbol: newCurrencySymbol,
                notifyLowStock: newNotifyLowStock
            };
            localStorage.setItem('personalizationSettings', JSON.stringify(settings));

            // Update global variables
            currencySymbol = newCurrencySymbol;
            notifyLowStock = newNotifyLowStock;

            // Re-render elements that use currency symbol
            updateCartTotals();
            updateDashboard();
            updateReportStatistics();
            loadProductsTable();
            loadCustomers();
            loadHistory();

            showNotification('success', 'Personalizaci√≥n Guardada', 'Tus ajustes de personalizaci√≥n han sido guardados.');
        }

        // Initialize theme on load
        window.addEventListener('load', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeToggleIcon(savedTheme);
            updateThemeButtons(savedTheme);
        });
    </script>
</body>

</html>